"use client";

import { useAuth } from "@/context/AuthContext";
import { useRouter } from "next/navigation";
import { useEffect, useMemo, useRef, useState } from "react";
import Link from "next/link";
import { Plus, Calendar, CheckSquare, Settings, Filter, Edit2, Trash2, Check, X, MessageCircle, LogOut, MapPin, Users, Clock, UserPlus, BarChart3, UserCircle2, Bell, FolderKanban, FileEdit, AlertTriangle } from "lucide-react";
import { db, auth, storage } from "@/lib/firebase";
import { collection, query, where, getDocs, orderBy, collectionGroup, deleteDoc, updateDoc, doc, getDoc, arrayUnion, setDoc, serverTimestamp, addDoc, onSnapshot, limit } from "firebase/firestore";
import { ref, uploadBytes, getDownloadURL, deleteObject } from "firebase/storage";
import TaskChat from "@/components/TaskChat";

import TaskCard from "@/components/TaskCard";
import { signOut } from "firebase/auth";

interface Event {
  id: string;
  title: string;
  location: string;
  startTime: any;
  status: string;
  participantsCount?: string;
  createdBy?: string;
  createdByEmail?: string;
  partners?: string | string[];
  members?: string[];
  team?: { name: string; role: string; email?: string; userId?: string }[];
  volunteerTasksPaused?: boolean;
  teamTasksPaused?: boolean;
}

interface JoinRequest {
  id: string;
  eventId: string;
  eventTitle?: string;
  requesterId?: string;
  requesterName?: string;
  requesterEmail?: string;
  ownerId?: string;
  ownerEmail?: string;
  status: "PENDING" | "APPROVED" | "REJECTED";
}

interface Task {
  id: string;
  title: string;
  description?: string;
  assignee: string;
  assigneeId?: string;
  assignees?: { name?: string; userId?: string; email?: string; phone?: string }[];
  status: "TODO" | "IN_PROGRESS" | "DONE" | "STUCK";
  dueDate: string;
  priority: "NORMAL" | "HIGH" | "CRITICAL";
  eventId: string;
  eventTitle: string;
  scope?: "event" | "project";
  lastMessageTime?: any;
  lastMessageBy?: string;
  readBy?: Record<string, boolean>;
  currentStatus?: string;
  nextStep?: string;
  lastMessageText?: string;
  lastMessageMentions?: { name?: string; userId?: string; email?: string }[];
  pendingApproval?: boolean;
  volunteerHours?: number | null;
  requiredCompletions?: number | null;
  remainingCompletions?: number | null;
}

interface TeamNote {
  id: string;
  text: string;
  createdAt?: any;
  updatedAt?: any;
}

interface Project {
  id: string;
  name?: string;
  status?: string;
  summary?: string;
  goal?: string;
  dueDate?: string;
  ownerId?: string;
  ownerEmail?: string;
  teamMembers?: { userId?: string; email?: string; fullName?: string }[];
  updatedAt?: any;
}

interface VolunteerRecord {
  id: string;
  name?: string;
  firstName?: string;
  lastName?: string;
  email?: string;
  phone?: string;
  phoneNormalized?: string;
  totalHours?: number;
  eventId: string;
  eventTitle?: string;
  createdAt?: any;
  scope?: "event" | "project" | "general";
  program?: string;
  year?: string;
  idNumber?: string;
}

interface EventRegistrant {
  id: string;
  name?: string;
  email?: string;
  phone?: string;
  eventId: string;
  eventTitle?: string;
  createdAt?: any;
}

type ManualCompletionPayload = {
  volunteerEmail: string;
  volunteerName: string;
  eventId?: string;
  eventTitle?: string;
  taskTitle: string;
  volunteerHours: number;
  scope?: "event" | "project" | "manual" | "general";
  taskId?: string;
};

type VolunteerErrorAction =
  | { type: "approve_completion"; approve: boolean; req: any }
  | { type: "manual_completion"; payload: ManualCompletionPayload };

type VolunteerErrorEntry = {
  id: string;
  ts: number;
  title: string;
  reason: string;
  context?: {
    volunteerEmail?: string;
    volunteerName?: string;
    eventTitle?: string;
    taskTitle?: string;
    scope?: "event" | "project" | "manual" | "general";
  };
  action: VolunteerErrorAction;
};

const matchAssignee = (opts: {
  taskData: any;
  userId?: string | null;
  userName?: string | null;
  userEmail?: string | null;
}) => {
  const { taskData, userId, userName, userEmail } = opts;
  const assigneeStr = (taskData.assignee || "").toLowerCase().trim();
  const userNameLower = (userName || "").toLowerCase().trim();
  const userEmailLower = (userEmail || "").toLowerCase().trim();
  const userEmailPrefix = userEmailLower ? userEmailLower.split("@")[0] : "";
  const assigneeId = taskData.assigneeId as string | undefined;
  const assigneesArr = (taskData.assignees as { name: string; userId?: string; email?: string }[] | undefined) ||
    (taskData.assignee ? [{ name: taskData.assignee, userId: taskData.assigneeId, email: (taskData as any).assigneeEmail }] : []);
  const mentionsArr = (taskData.lastMessageMentions as { name?: string; userId?: string; email?: string }[] | undefined) || [];
  const isAssigned =
    (assigneeId && userId && assigneeId === userId) ||
    assigneesArr.some(a => a.userId && userId && a.userId === userId) ||
    assigneesArr.some(a => a.email && userEmailLower && a.email.toLowerCase().trim() === userEmailLower) ||
    (assigneeStr && (
      (userNameLower && assigneeStr === userNameLower) ||
      (userEmailPrefix && assigneeStr === userEmailPrefix) ||
      assigneeStr === "אני"
    )) ||
    assigneesArr.some(a => {
      const nameLower = (a.name || "").toLowerCase().trim();
      return (userNameLower && nameLower === userNameLower) ||
        (userEmailPrefix && nameLower === userEmailPrefix) ||
        nameLower === "אני";
    });
  const isMentioned = mentionsArr.some(m =>
    (m.userId && userId && m.userId === userId) ||
    (m.email && userEmail && m.email.toLowerCase() === userEmail.toLowerCase())
  );
  return { isAssigned, isMentioned, assigneesArr, assigneeId };
};

export default function Dashboard() {
  const { user, loading } = useAuth();
  const router = useRouter();
  const [events, setEvents] = useState<Event[]>([]);
  const [loadingEvents, setLoadingEvents] = useState(true);
  const [projects, setProjects] = useState<Project[]>([]);
  const [loadingProjects, setLoadingProjects] = useState(false);
  const [projectIndex, setProjectIndex] = useState<Record<string, Project>>({});

  // My Tasks State
  const [myTasks, setMyTasks] = useState<Task[]>([]);
  const [loadingTasks, setLoadingTasks] = useState(true);

  // Stats State
  const [stats, setStats] = useState({ myEvents: 0, attendees: 0, partners: 0, tasks: 0 });
  const [loadingStats, setLoadingStats] = useState(true);
  const [activePanel, setActivePanel] = useState<"stats" | "users" | "notifications" | "volunteers" | "registrants" | null>("stats");
  const [usersList, setUsersList] = useState<{ id: string; fullName?: string; email?: string; role?: string }[]>([]);
  const [loadingUsers, setLoadingUsers] = useState(true);
  const [usersError, setUsersError] = useState<string | null>(null);
  const [volunteersList, setVolunteersList] = useState<VolunteerRecord[]>([]);
  const [loadingVolunteers, setLoadingVolunteers] = useState(true);
  const [showAllVolunteers, setShowAllVolunteers] = useState(false);
  const [registrantsList, setRegistrantsList] = useState<EventRegistrant[]>([]);
  const [loadingRegistrants, setLoadingRegistrants] = useState(true);
  const [registrantSearch, setRegistrantSearch] = useState("");
  const [showRegisterEventsModal, setShowRegisterEventsModal] = useState(false);
  const [registerEventsSelection, setRegisterEventsSelection] = useState<Set<string>>(new Set());
  const [savingRegisterEvents, setSavingRegisterEvents] = useState(false);
  const [registerEventsAll, setRegisterEventsAll] = useState<any[]>([]);
  const [eventEdits, setEventEdits] = useState<Record<string, { title?: string; description?: string; location?: string; startTime?: string; hero?: string }>>({});
  const [eventFilesMap, setEventFilesMap] = useState<Record<string, { id: string; name?: string; url?: string }[]>>({});
  const [loadingFilesFor, setLoadingFilesFor] = useState<string | null>(null);
  const [registerGallery, setRegisterGallery] = useState<{ id: string; name?: string; url?: string; storagePath?: string }[]>([]);
  const [loadingRegisterGallery, setLoadingRegisterGallery] = useState(false);
  const [uploadingRegisterGallery, setUploadingRegisterGallery] = useState(false);
  const [deletingRegisterGalleryId, setDeletingRegisterGalleryId] = useState<string | null>(null);
  const registerGalleryInputRef = useRef<HTMLInputElement | null>(null);
  const [volunteerSearch, setVolunteerSearch] = useState("");
  const [editingVolunteer, setEditingVolunteer] = useState<VolunteerRecord | null>(null);
  const [editVolunteerName, setEditVolunteerName] = useState("");
  const [editVolunteerEmail, setEditVolunteerEmail] = useState("");
  const [editVolunteerPhone, setEditVolunteerPhone] = useState("");
  const [savingVolunteer, setSavingVolunteer] = useState(false);
  const [manualTaskTitle, setManualTaskTitle] = useState("");
  const [manualTaskHours, setManualTaskHours] = useState("");
  const [manualEventTitle, setManualEventTitle] = useState("");
  const [manualSaving, setManualSaving] = useState(false);
  const [deletingVolunteerId, setDeletingVolunteerId] = useState<string | null>(null);
  const [confirmDeleteVolunteer, setConfirmDeleteVolunteer] = useState<VolunteerRecord | null>(null);
  const [viewVolunteer, setViewVolunteer] = useState<{ id: string; name?: string; firstName?: string; lastName?: string; email?: string; phone?: string; program?: string; year?: string; idNumber?: string } | null>(null);
  const [volTasksPending, setVolTasksPending] = useState<Task[]>([]);
  const [volTasksDone, setVolTasksDone] = useState<Task[]>([]);
  const [volTasksHours, setVolTasksHours] = useState<number>(0);
  const [loadingVolTasks, setLoadingVolTasks] = useState(false);
  const [volTasksError, setVolTasksError] = useState<string | null>(null);
  const [completionRequests, setCompletionRequests] = useState<any[]>([]);
  const [showRequestsModal, setShowRequestsModal] = useState(false);
  const [volunteerErrorLog, setVolunteerErrorLog] = useState<VolunteerErrorEntry[]>([]);
  const [retryingErrorIds, setRetryingErrorIds] = useState<Record<string, boolean>>({});
  const [userEventsMap, setUserEventsMap] = useState<Record<string, Event[]>>({});
  const [openUserEventsId, setOpenUserEventsId] = useState<string | null>(null);
  const [joinRequests, setJoinRequests] = useState<Record<string, "PENDING" | "APPROVED" | "REJECTED">>({});
  const [incomingJoinRequests, setIncomingJoinRequests] = useState<JoinRequest[]>([]);
  const [loadingNotifications, setLoadingNotifications] = useState(true);
  const [notificationTasks, setNotificationTasks] = useState<Task[]>([]);
  const [deleteEventRemoveTasks, setDeleteEventRemoveTasks] = useState(false);
  const [unreadEditRequests, setUnreadEditRequests] = useState(0);
  const [unassignedTasksCount, setUnassignedTasksCount] = useState(0);
  const [teamNotes, setTeamNotes] = useState<TeamNote[]>([]);
  const [loadingNotes, setLoadingNotes] = useState(true);
  const [newNote, setNewNote] = useState("");
  const [editingNoteId, setEditingNoteId] = useState<string | null>(null);
  const [editingNoteText, setEditingNoteText] = useState("");
  const [assigneeWhatsappModal, setAssigneeWhatsappModal] = useState<{
    taskId: string;
    taskTitle: string;
    eventTitle?: string;
    assigneeName?: string;
    assigneeEmail?: string;
    assigneeUserId?: string;
    phone: string;
    message: string;
    loadingPhone?: boolean;
    sending?: boolean;
    error?: string | null;
  } | null>(null);

  const filteredVolunteers = useMemo(() => {
    const query = volunteerSearch.trim().toLowerCase();
    if (!query) return volunteersList;
    return volunteersList.filter((vol) => {
      const name = vol.name || "";
      return name.toLowerCase().includes(query);
    });
  }, [volunteerSearch, volunteersList]);

  const filteredRegistrants = useMemo(() => {
    const query = registrantSearch.trim().toLowerCase();
    if (!query) return registrantsList;
    return registrantsList.filter((reg) => {
      const name = (reg.name || "").toLowerCase();
      const email = (reg.email || "").toLowerCase();
      const phone = (reg.phone || "").toLowerCase();
      const eventTitle = (reg.eventTitle || "").toLowerCase();
      return name.includes(query) || email.includes(query) || phone.includes(query) || eventTitle.includes(query);
    });
  }, [registrantSearch, registrantsList]);

  // Filter State
  const [filterEvent, setFilterEvent] = useState<string>("all");
  const [sortBy, setSortBy] = useState<string>("none");

  // Edit/Delete State
  const [editingTask, setEditingTask] = useState<Task | null>(null);
  // State for editing status/next step
  const [editingStatusTask, setEditingStatusTask] = useState<Task | null>(null);
  const [editingDateTask, setEditingDateTask] = useState<Task | null>(null);
  const [deletingTaskId, setDeletingTaskId] = useState<string | null>(null);
  const [confirmingEventId, setConfirmingEventId] = useState<string | null>(null);
  const [confirmingProjectId, setConfirmingProjectId] = useState<string | null>(null);

  // Chat State
  const [chatTask, setChatTask] = useState<Task | null>(null);
  const isProjectManager = (user?.email || "").toLowerCase() === "bengo0469@gmail.com";
  const isAdmin = isProjectManager;

  // Non-admins must not see registrants panel
  useEffect(() => {
    if (!isAdmin) {
      setRegistrantsList([]);
      setLoadingRegistrants(false);
      if (activePanel === "registrants") setActivePanel(null);
    }
  }, [isAdmin, activePanel]);

  useEffect(() => {
    if (!loading && !user) {
      router.push("/login");
    }
  }, [user, loading, router]);

  useEffect(() => {
    if (!db || !showRegisterEventsModal) return;
    setLoadingRegisterGallery(true);
    getDocs(query(collection(db, "register_gallery"), orderBy("createdAt", "desc"), limit(24)))
      .then((snap) => {
        const items = snap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));
        setRegisterGallery(items);
      })
      .catch((err) => {
        console.error("Error loading register gallery", err);
      })
      .finally(() => setLoadingRegisterGallery(false));
  }, [db, showRegisterEventsModal]);

  const toPartnerArray = (raw: any): string[] => {
    if (!raw) return [];
    if (Array.isArray(raw)) return raw.map(p => (p || "").toString().trim()).filter(Boolean);
    if (typeof raw === "string") return raw.split(/[,\n]/).map(p => p.trim()).filter(Boolean);
    return [];
  };

  const isHeicFile = (file?: File | null) => {
    if (!file) return false;
    const name = (file.name || "").toLowerCase();
    const type = (file.type || "").toLowerCase();
    return name.endsWith(".heic") || name.endsWith(".heif") || type === "image/heic" || type === "image/heif";
  };

  const convertHeicToJpeg = async (file: File): Promise<File | null> => {
    try {
      if (typeof window === "undefined") return null;
      const heic2any = (await import("heic2any")).default;
      const output = await heic2any({
        blob: file,
        toType: "image/jpeg",
        quality: 0.9,
      });
      const blob = Array.isArray(output) ? output[0] : output;
      const base = file.name.replace(/\.[^/.]+$/, "") || "image";
      return new File([blob], `${base}.jpg`, { type: "image/jpeg" });
    } catch (err) {
      console.warn("Failed to convert HEIC; will upload original", err);
      return null;
    }
  };

  const convertHeicServerSide = async (file: File): Promise<File | null> => {
    try {
      const form = new FormData();
      form.append("file", file);
      const res = await fetch("/api/convert-heic", { method: "POST", body: form });
      if (!res.ok) throw new Error(`Server convert failed: ${res.status}`);
      const blob = await res.blob();
      const base = file.name.replace(/\.[^/.]+$/, "") || "image";
      return new File([blob], `${base}.jpg`, { type: "image/jpeg" });
    } catch (err) {
      console.error("Server HEIC convert failed", err);
      return null;
    }
  };

  const getErrorMessage = (err: any) => {
    if (!err) return "תקלה לא ידועה";
    if (typeof err === "string") return err;
    if (err?.message) return err.message;
    try {
      return JSON.stringify(err);
    } catch {
      return "תקלה לא ידועה";
    }
  };

  const normalizePhoneValue = (val?: string) => {
    const digits = (val || "").toString().replace(/\D/g, "");
    if (!digits) return "";
    if (digits.startsWith("972")) return digits;
    if (digits.startsWith("0")) return `972${digits.slice(1)}`;
    return digits;
  };

  const recordVolunteerError = (entry: Omit<VolunteerErrorEntry, "id" | "ts">) => {
    const id = `vol-err-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
    setVolunteerErrorLog(prev => [{ ...entry, id, ts: Date.now() }, ...prev].slice(0, 50));
  };

  const formatVolunteerErrorTime = (ts?: number) => {
    if (!ts) return "";
    return new Date(ts).toLocaleString("he-IL", { dateStyle: "short", timeStyle: "short" });
  };

  const fetchWhatsappConfig = async () => {
    if (!db) return null;
    try {
      const snap = await getDoc(doc(db, "integrations", "whatsapp"));
      return snap.exists() ? (snap.data() as any) : null;
    } catch (err) {
      console.warn("WhatsApp config fetch failed", err);
      return null;
    }
  };

  const resolveAssigneePhone = async (assignee?: { userId?: string; email?: string; phone?: string }) => {
    if (!db || !assignee) return "";
    if (assignee.phone) return normalizePhoneValue(assignee.phone);
    try {
      if (assignee.userId) {
        const snap = await getDoc(doc(db, "users", assignee.userId));
        if (snap.exists()) {
          const data = snap.data() as any;
          const phone = data.phone || data.phoneNumber || data.phoneNormalized;
          if (phone) return normalizePhoneValue(phone);
        }
      }
    } catch (err) {
      console.warn("User phone lookup by id failed", err);
    }
    const emailLower = (assignee.email || "").trim().toLowerCase();
    if (emailLower) {
      try {
        const snap = await getDocs(query(collection(db, "users"), where("email", "==", emailLower)));
        const data = snap.docs[0]?.data() as any;
        const phone = data?.phone || data?.phoneNumber || data?.phoneNormalized;
        if (phone) return normalizePhoneValue(phone);
      } catch (err) {
        console.warn("User phone lookup by email failed", err);
      }
    }
    return "";
  };

  const isProjectTaskRef = (ref?: any) => {
    if (!ref?.path) return false;
    const path = ref.path.toString();
    const marker = "/documents/";
    const idx = path.indexOf(marker);
    if (idx !== -1) {
      const sub = path.slice(idx + marker.length);
      if (sub.startsWith("projects/")) return true;
    }
    return path.startsWith("projects/") || path.includes("/projects/");
  };

  const handleRegisterGalleryUpload = async (files: File[]) => {
    if (!db || !storage || !isAdmin) return;
    setUploadingRegisterGallery(true);
    try {
      const uploadQueue = files.filter(Boolean);
      for (const file of uploadQueue) {
        let uploadFile = file;
        if (isHeicFile(file)) {
          const converted = await convertHeicToJpeg(file) || await convertHeicServerSide(file);
          if (converted) {
            uploadFile = converted;
          } else {
            alert(`לא הצלחנו להמיר HEIC עבור "${file.name}". אנא העלה JPG/PNG.`);
            continue;
          }
        }

        const path = `register_gallery/${Date.now()}-${uploadFile.name}`;
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, uploadFile);
        const url = await getDownloadURL(storageRef);
        const docRef = await addDoc(collection(db, "register_gallery"), {
          name: uploadFile.name,
          url,
          storagePath: path,
          createdAt: serverTimestamp(),
        });
        setRegisterGallery(prev => [{ id: docRef.id, name: uploadFile.name, url, storagePath: path }, ...prev]);
      }
    } catch (err) {
      console.error("Error uploading register gallery image", err);
      alert("שגיאה בהעלאת תמונה לגלריה");
    } finally {
      setUploadingRegisterGallery(false);
    }
  };

  const handleDeleteRegisterGallery = async (img: { id: string; storagePath?: string }) => {
    if (!db || !storage || !isAdmin) return;
    if (typeof window !== "undefined") {
      const ok = window.confirm("למחוק את התמונה מהגלריה?");
      if (!ok) return;
    }
    setDeletingRegisterGalleryId(img.id);
    try {
      await deleteDoc(doc(db, "register_gallery", img.id));
      if (img.storagePath) {
        try {
          await deleteObject(ref(storage, img.storagePath));
        } catch (err) {
          console.error("Failed deleting storage object", err);
        }
      }
      setRegisterGallery(prev => prev.filter(item => item.id !== img.id));
    } catch (err) {
      console.error("Error deleting register gallery image", err);
      alert("שגיאה במחיקת תמונה");
    } finally {
      setDeletingRegisterGalleryId(null);
    }
  };

  const toDateSafe = (val: any): Date | null => {
    if (!val) return null;
    if (val.toDate) {
      try {
        const d = val.toDate();
        return isNaN(d.getTime()) ? null : d;
      } catch {
        /* ignore */
      }
    }
    if (val.seconds) {
      const d = new Date(val.seconds * 1000);
      return isNaN(d.getTime()) ? null : d;
    }
    if (val instanceof Date) {
      return isNaN(val.getTime()) ? null : val;
    }
    if (typeof val === "string") {
      const d = new Date(val);
      return isNaN(d.getTime()) ? null : d;
    }
    return null;
  };

  const computeNextOccurrence = (
    baseDate: Date,
    recurrence: "NONE" | "WEEKLY" | "BIWEEKLY" | "MONTHLY",
    recurrenceEnd?: Date | null
  ) => {
    if (!(baseDate instanceof Date) || isNaN(baseDate.getTime())) return baseDate;
    if (recurrence === "NONE") return baseDate;
    const now = Date.now();
    let candidate = new Date(baseDate);
    let guard = 0;
    const addInterval = () => {
      if (recurrence === "WEEKLY") candidate = new Date(candidate.getTime() + 7 * 24 * 60 * 60 * 1000);
      else if (recurrence === "BIWEEKLY") candidate = new Date(candidate.getTime() + 14 * 24 * 60 * 60 * 1000);
      else if (recurrence === "MONTHLY") {
        const next = new Date(candidate);
        next.setMonth(next.getMonth() + 1);
        candidate = next;
      }
    };
    while (candidate.getTime() < now && guard < 200) {
      addInterval();
      guard += 1;
    }
    if (recurrenceEnd && recurrenceEnd.getTime && recurrenceEnd.getTime() > 0) {
      const endTs = recurrenceEnd.getTime();
      if (candidate.getTime() > endTs) {
        if (endTs >= now) candidate = new Date(endTs);
      }
    }
    return candidate;
  };

  const normalizeRecurrence = (val: any): "NONE" | "WEEKLY" | "BIWEEKLY" | "MONTHLY" => {
    const raw = (val || "").toString().toUpperCase().trim();
    if (!raw || raw === "NONE") return "NONE";
    if (raw.includes("BIWEEK") || raw.includes("2W") || raw.includes("FORTNIGHT") || (raw.includes("שבוע") && raw.includes("יים")) || raw.includes("שבועיים")) {
      return "BIWEEKLY";
    }
    if (raw.includes("MONTH") || raw.includes("חודש")) return "MONTHLY";
    if (raw.includes("WEEK") || raw.includes("שבוע")) return "WEEKLY";
    return "NONE";
  };

  const fetchTasksForContainers = async ({
    eventIds = [],
    projectIds = [],
    eventLookup,
    projectLookup,
    currentUser,
    includeMentions = true,
  }: {
    eventIds: string[];
    projectIds: string[];
    eventLookup: Map<string, any>;
    projectLookup: Map<string, any>;
    currentUser: { id?: string; name?: string | null; email?: string | null };
    includeMentions?: boolean;
  }) => {
    if (!db) return { tasks: [] as Task[], notif: [] as Task[], tasksInMyEvents: 0 };
    const tasks: Task[] = [];
    const notif: Task[] = [];
    let tasksInMyEvents = 0;

    const loadFor = async (scope: "event" | "project", id: string) => {
      const parent = scope === "event" ? eventLookup.get(id) : projectLookup.get(id);
      if (!parent) return;
      try {
        const snap = await getDocs(collection(db!, scope === "event" ? "events" : "projects", id, "tasks"));
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const match = matchAssignee({
            taskData: data,
            userId: currentUser.id,
            userName: currentUser.name,
            userEmail: currentUser.email,
          });
          const baseTask: Task = {
            id: docSnap.id,
            title: data.title,
            description: data.description,
            assignee: data.assignee,
            assigneeId: data.assigneeId,
            assignees: data.assignees,
            status: (data.status as Task["status"]) || "TODO",
            dueDate: data.dueDate,
            priority: (data.priority as Task["priority"]) || "NORMAL",
            eventId: id,
            eventTitle: (scope === "event" ? parent?.title : parent?.name) || (scope === "project" ? "פרויקט" : "אירוע לא ידוע"),
            scope,
            currentStatus: data.currentStatus,
            nextStep: data.nextStep,
            lastMessageTime: data.lastMessageTime,
            lastMessageBy: data.lastMessageBy,
            readBy: data.readBy,
            lastMessageText: data.lastMessageText,
            lastMessageMentions: data.lastMessageMentions,
          };
          tasks.push(baseTask);
          const shouldIncludeNotif = match.isAssigned || (includeMentions && match.isMentioned);
          if (shouldIncludeNotif) {
            notif.push({
              ...baseTask,
              assignees: match.assigneesArr,
              assigneeId: match.assigneeId,
            });
          }
          if (scope === "event") tasksInMyEvents += 1;
        });
      } catch (err) {
        console.error("Failed loading tasks for", scope, id, err);
      }
    };

    await Promise.all([
      ...eventIds.map(eid => loadFor("event", eid)),
      ...projectIds.map(pid => loadFor("project", pid)),
    ]);

    return { tasks, notif, tasksInMyEvents };
  };

  const isEventActive = (event: Event) => {
    const statusLower = (event.status || "").toString().toLowerCase();
    if (["done", "cancelled", "canceled", "בוטל"].includes(statusLower)) return false;
    return true;
  };

  const isProjectActive = (project: Project) => {
    const statusLower = (project.status || "").toString().toLowerCase();
    return !["הושלם", "done", "completed", "סגור", "cancelled", "canceled"].includes(statusLower);
  };

  const isEventDeletedFlag = (eventObj: any) => {
    const statusLower = (eventObj?.status || "").toString().toLowerCase();
    return eventObj?.deleted === true || ["deleted", "cancelled", "canceled", "archive", "archived"].includes(statusLower);
  };

  const normalizeKey = (val?: string | null) => (val || "").toString().trim().toLowerCase();
  const isProjectOwner = (proj: Project, currentUser?: typeof user) => {
    const u = currentUser || user;
    if (!u) return false;
    return (
      (proj.ownerId && proj.ownerId === u.uid) ||
      (proj.ownerEmail && u.email && normalizeKey(proj.ownerEmail) === normalizeKey(u.email))
    );
  };

  // Onboarding gate: new users must complete profile
  useEffect(() => {
    const checkOnboarding = async () => {
      if (!db || !user) return;
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || !userDoc.data()?.onboarded) {
          router.push("/onboarding");
        }
      } catch (err) {
        console.error("Error checking onboarding:", err);
      }
    };
    checkOnboarding();
  }, [user]);

  // Refresh notifications (messages/join requests) when panel opens
  useEffect(() => {
    const fetchNotificationTasks = async () => {
      if (!db || !user || activePanel !== "notifications") return;
      try {
        setLoadingNotifications(true);
        const tasksSnapshot = await getDocs(collectionGroup(db, "tasks"));
        const notif: Task[] = [];
        const userName = user.displayName || "";
        const userEmail = user.email || "";
        const currentUid = user.uid;
        const eventLookup = new Map(events.map(e => [e.id, e]));
        const projectLookup = new Map(Object.entries(projectIndex || {}));

        tasksSnapshot.forEach(docSnap => {
          const taskData = docSnap.data();
          const isProjectTask = isProjectTaskRef(docSnap.ref);
          const parentCollectionId = docSnap.ref.parent.parent?.parent?.id;
          const eventId = docSnap.ref.parent.parent?.id || "";
          let event = isProjectTask ? projectLookup.get(eventId) : eventLookup.get(eventId);
          if (!event && isProjectTask) {
            event = { id: eventId, title: taskData.eventTitle || "פרויקט" } as any;
          }
          // Skip tasks whose parent event no longer exists or marked deleted
          if (!isProjectTask && (!event || isEventDeletedFlag(event))) {
            return;
          }
          const isVolunteerTask = taskData.isVolunteerTask === true || taskData.volunteerHours != null;
          const teamPaused = !isProjectTask && (event as any)?.teamTasksPaused;
          if (teamPaused && !isVolunteerTask) return;

          const match = matchAssignee({
            taskData,
            userId: currentUid,
            userName,
            userEmail,
          });

          if (match.isAssigned || match.isMentioned) {
            notif.push({
              id: docSnap.id,
              title: taskData.title,
              dueDate: taskData.dueDate,
              priority: (taskData.priority as "NORMAL" | "HIGH" | "CRITICAL") || "NORMAL",
              assignee: taskData.assignee,
              assigneeId: match.assigneeId,
              assignees: match.assigneesArr,
              status: (taskData.status as "TODO" | "IN_PROGRESS" | "DONE" | "STUCK") || "TODO",
              eventId: eventId,
              eventTitle: isProjectTask
                ? (event as any)?.name || (event as any)?.title || taskData.eventTitle || "פרויקט"
                : (event as any)?.title || taskData.eventTitle || "אירוע לא ידוע",
              scope: isProjectTask ? "project" : "event",
              currentStatus: taskData.currentStatus || "",
              nextStep: taskData.nextStep || "",
              lastMessageTime: taskData.lastMessageTime || null,
              lastMessageBy: taskData.lastMessageBy || "",
              readBy: taskData.readBy || {},
              lastMessageMentions: (taskData.lastMessageMentions as any) || [],
              requiredCompletions: taskData.requiredCompletions != null ? Number(taskData.requiredCompletions) : null,
              remainingCompletions: taskData.remainingCompletions != null ? Number(taskData.remainingCompletions) : null
            } as Task);
          }
        });
        setNotificationTasks(notif);
      } catch (err) {
        console.error("Error loading notification tasks:", err);
      } finally {
        setLoadingNotifications(false);
      }
    };
    fetchNotificationTasks();
  }, [activePanel, user, events, db]);

  // Fetch unread edit requests for admin badge
  useEffect(() => {
    const loadUnread = async () => {
      if (!db || !isAdmin) return;
      try {
        const snap = await getDocs(query(collection(db, "edit_requests"), where("status", "==", "UNREAD")));
        setUnreadEditRequests(snap.size);
      } catch (err) {
        console.error("Failed loading edit request unread count", err);
      }
    };
    loadUnread();
  }, [db, isAdmin]);

  // Team notes (per user)
  useEffect(() => {
    const loadNotes = async () => {
      if (!db || !user) {
        setLoadingNotes(false);
        return;
      }
      try {
        setLoadingNotes(true);
        // Avoids composite index requirement: filter by owner then sort locally.
        const snap = await getDocs(
          query(collection(db, "team_meeting_notes"), where("createdBy", "==", user.uid))
        );
        const notes: TeamNote[] = [];
        snap.forEach(n => {
          const data = n.data() as any;
          notes.push({ id: n.id, text: data.text || "", createdAt: data.createdAt, updatedAt: data.updatedAt });
        });
        notes.sort((a, b) => {
          const aTs = a.createdAt?.seconds || 0;
          const bTs = b.createdAt?.seconds || 0;
          return bTs - aTs;
        });
        setTeamNotes(notes);
      } catch (err) {
        console.error("Failed loading team notes", err);
      } finally {
        setLoadingNotes(false);
      }
    };
    loadNotes();
  }, [db, user]);

  useEffect(() => {
    const fetchData = async () => {
      if (!db || !user) {
        setLoadingEvents(false);
        setLoadingProjects(false);
        setLoadingTasks(false);
        setLoadingStats(false);
        setLoadingUsers(false);
        setLoadingVolunteers(false);
        setLoadingNotifications(false);
        return;
      }

      try {
        setLoadingStats(true);
        setLoadingProjects(true);
        setLoadingUsers(true);
        setLoadingVolunteers(true);
        setLoadingNotifications(true);
        setUsersError(null);
        // Fetch all events (for per-user stats)
        const allEventsSnapshot = await getDocs(query(collection(db, "events"), orderBy("createdAt", "desc")));
        const allEventsRaw = allEventsSnapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        })) as any[];
        const allEventsData: Event[] = [];
        for (const ev of allEventsRaw) {
          const recurrence = normalizeRecurrence(ev.recurrence);
          if (recurrence !== "NONE") {
            const startDate = toDateSafe(ev.startTime) || new Date();
            const endDate = toDateSafe(ev.endTime);
            const recurrenceEnd = toDateSafe(ev.recurrenceEndDate);
            const next = computeNextOccurrence(startDate, recurrence, recurrenceEnd);
            const durationMs = endDate && startDate ? endDate.getTime() - startDate.getTime() : null;
            const newEnd = durationMs && durationMs > 0 ? new Date(next.getTime() + durationMs) : endDate;
            if (next.getTime() !== startDate.getTime()) {
              try {
                await updateDoc(doc(db, "events", ev.id), {
                  startTime: next,
                  ...(newEnd ? { endTime: newEnd } : {}),
                });
              } catch (err) {
                console.warn("Failed updating recurring event date", ev.id, err);
              }
            }
            allEventsData.push({
              ...ev,
              startTime: next,
              endTime: newEnd || ev.endTime,
              recurrence,
            } as Event);
          } else {
            allEventsData.push(ev as Event);
          }
        }
        // Fetch projects (for volunteer lookup from projects)
        const allProjectsSnapshot = await getDocs(collection(db, "projects"));
        const allProjectsData = allProjectsSnapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        })) as any[];
        setProjectIndex(Object.fromEntries(allProjectsData.map((p: any) => [p.id, p])));
        const eventsByCreator: Record<string, Event[]> = {};
        const addToMap = (key: string | undefined | null, ev: Event) => {
          const normKey = normalizeKey(key);
          if (!normKey) return;
          if (!eventsByCreator[normKey]) eventsByCreator[normKey] = [];
          const exists = eventsByCreator[normKey].some(e => e.id === ev.id);
          if (!exists) eventsByCreator[normKey].push(ev);
        };
        allEventsData.forEach(ev => {
          addToMap(ev.createdBy, ev);
          addToMap(ev.createdByEmail, ev);
          const teamArr = (ev as any).team as { userId?: string; email?: string }[] | undefined;
          (teamArr || []).forEach(member => {
            addToMap(member.userId, ev);
            if (member.email) addToMap(member.email, ev);
          });
        });
        setUserEventsMap(eventsByCreator);

        // Fetch events relevant to current user
        const eventsForUser = allEventsData.filter(e =>
          (Array.isArray((e as any).members) && (e as any).members.includes(user.uid)) ||
          (e.createdByEmail && user.email && normalizeKey(e.createdByEmail) === normalizeKey(user.email)) ||
          (e.createdBy && e.createdBy === user.uid)
        );
        const sortedByDate = [...eventsForUser].sort((a, b) => {
          const aDate = toDateSafe(a.startTime)?.getTime() || 0;
          const bDate = toDateSafe(b.startTime)?.getTime() || 0;
          return aDate - bDate;
        });
        const displayEventIds = new Set(sortedByDate.map(e => e.id));
        setEvents(sortedByDate);

        // Fetch projects relevant to current user
        const projectsForUser = allProjectsData.filter((p) => {
          const ownerMatch =
            p.ownerId === user.uid ||
            (p.ownerEmail && user.email && normalizeKey(p.ownerEmail) === normalizeKey(user.email));
          const teamMembers = (p as any).teamMembers as { userId?: string; email?: string }[] | undefined;
          const teamMatch = (teamMembers || []).some(
            (m) =>
              (m.userId && m.userId === user.uid) ||
              (m.email && user.email && normalizeKey(m.email) === normalizeKey(user.email))
          );
          return ownerMatch || teamMatch;
        });
        const activeProjects = projectsForUser
          .filter(isProjectActive)
          .sort((a, b) => {
            const aTime = a.updatedAt?.seconds || 0;
            const bTime = b.updatedAt?.seconds || 0;
            return bTime - aTime;
          })
          .map((p) => ({
            ...p,
            name: (p as any).name || (p as any).title || "פרויקט ללא שם",
            summary: (p as any).summary || (p as any).description || "",
          }));
        setProjects(activeProjects);
        setLoadingProjects(false);
        const myCreatedEvents = allEventsData.filter(e =>
          e.createdBy === user.uid ||
          (e.createdByEmail && user.email && normalizeKey(e.createdByEmail) === normalizeKey(user.email))
        );
        const myEventIds = new Set(myCreatedEvents.map(e => e.id));
        const uniquePartners = new Set<string>();
        myCreatedEvents.forEach(e => {
          toPartnerArray((e as any).partners).forEach(p => uniquePartners.add(p));
        });

        // Fetch My Tasks (using Collection Group Query)
        // Note: This requires a composite index in Firestore if we filter by multiple fields
        // For now, we'll fetch all tasks and filter in client to match assignee name flexibly
        const tasksQuery = query(collectionGroup(db, "tasks"));
        const tasksSnapshot = await getDocs(tasksQuery);

        const userTasks: Task[] = [];
        const notifTasks: Task[] = [];
        const userName = user.displayName || "";
        const userEmail = user.email || "";
        let tasksInMyEvents = 0;
        let unassignedCount = 0;

        const eventLookup = new Map(allEventsData.map(e => [e.id, e]));
        const projectLookup = new Map(allProjectsData.map(p => [p.id, p]));

        const isTaskAssignedToCurrentUser = (task: any) => {
          const match = matchAssignee({
            taskData: task,
            userId: user.uid,
            userName,
            userEmail,
          });
          return match.isAssigned;
        };

        tasksSnapshot.forEach(doc => {
          const taskData = doc.data();
          const isProjectTask = isProjectTaskRef(doc.ref);
          const scope: "event" | "project" = isProjectTask ? "project" : "event";
          const eventId = doc.ref.parent.parent?.id || "";
          let container = isProjectTask ? projectLookup.get(eventId) : eventLookup.get(eventId);
          if (!container && isProjectTask) {
            container = { id: eventId, name: taskData.eventTitle || taskData.title || "פרויקט" } as any;
          }
          if (!container) return;
          if (!isProjectTask && isEventDeletedFlag(container)) return;
          const isVolunteerTask = taskData.isVolunteerTask === true || taskData.volunteerHours != null;
          const teamPaused = !isProjectTask && (container as any)?.teamTasksPaused;
          if (teamPaused && !isVolunteerTask) return;
          if (scope === "event" && myEventIds.has(eventId)) {
            tasksInMyEvents += 1;
          }

          const match = matchAssignee({
            taskData,
            userId: user.uid,
            userName,
            userEmail,
          });
          const mentionsArr = (taskData.lastMessageMentions as { name?: string; userId?: string; email?: string }[] | undefined) || [];
          const containerTitle = scope === "project"
            ? (container as any)?.name || (container as any)?.title || taskData.eventTitle || "פרויקט"
            : (container as any)?.title || taskData.eventTitle || "אירוע לא ידוע";

          if (match.isAssigned || match.isMentioned) {
            notifTasks.push({
              id: doc.id,
              title: taskData.title,
              dueDate: taskData.dueDate,
              priority: (taskData.priority as "NORMAL" | "HIGH" | "CRITICAL") || "NORMAL",
              assignee: taskData.assignee,
              assigneeId: match.assigneeId,
              assignees: match.assigneesArr,
              status: (taskData.status as "TODO" | "IN_PROGRESS" | "DONE" | "STUCK") || "TODO",
              eventId,
              eventTitle: containerTitle,
              scope,
              currentStatus: taskData.currentStatus || "",
              nextStep: taskData.nextStep || "",
              lastMessageTime: taskData.lastMessageTime || null,
              lastMessageBy: taskData.lastMessageBy || "",
              readBy: taskData.readBy || {},
              lastMessageMentions: mentionsArr,
              lastMessageText: taskData.lastMessageText || "",
              requiredCompletions: taskData.requiredCompletions != null ? Number(taskData.requiredCompletions) : null,
              remainingCompletions: taskData.remainingCompletions != null ? Number(taskData.remainingCompletions) : null
            } as Task);
          }

          const hasAssignees =
            match.assigneesArr.length > 0 &&
            match.assigneesArr.some(a => (a.userId || a.email || a.name));
          const isVolunteer = taskData.isVolunteerTask === true;
          if (scope === "event" && displayEventIds.has(eventId) && !isVolunteer && !hasAssignees && !taskData.assigneeId && !taskData.assignee) {
            unassignedCount += 1;
          }

          const isAssignedToUser = taskData.status !== "DONE" && isTaskAssignedToCurrentUser({
            ...taskData,
            assignees: match.assigneesArr,
            assigneeEmail: (taskData as any).assigneeEmail || (match.assigneesArr[0]?.email) || taskData.assigneeEmail,
          });

          if (isAssignedToUser) {
            userTasks.push({
              id: doc.id,
              title: taskData.title,
              dueDate: taskData.dueDate,
              priority: (taskData.priority as "NORMAL" | "HIGH" | "CRITICAL") || "NORMAL",
              assignee: taskData.assignee,
              assigneeId: match.assigneeId,
              assigneeEmail: (taskData as any).assigneeEmail || (match.assigneesArr[0]?.email) || "",
              assignees: match.assigneesArr,
              status: (taskData.status as "TODO" | "IN_PROGRESS" | "DONE" | "STUCK") || "TODO",
              eventId,
              eventTitle: containerTitle,
              scope,
              currentStatus: taskData.currentStatus || "",
              nextStep: taskData.nextStep || "",
              lastMessageTime: taskData.lastMessageTime || null,
              lastMessageBy: taskData.lastMessageBy || "",
              readBy: taskData.readBy || {},
              lastMessageText: taskData.lastMessageText || "",
              requiredCompletions: taskData.requiredCompletions != null ? Number(taskData.requiredCompletions) : null,
              remainingCompletions: taskData.remainingCompletions != null ? Number(taskData.remainingCompletions) : null
            } as Task);
          }
        });

        setMyTasks(userTasks);
        setNotificationTasks(notifTasks);
        setUnassignedTasksCount(unassignedCount);
        const attendeesByEvent = await Promise.all(
          myCreatedEvents.map(async (ev) => {
            try {
              const attendeesSnap = await getDocs(collection(db!, "events", ev.id, "attendees"));
              return attendeesSnap.size;
            } catch (err) {
              console.error("Error loading attendees for event", ev.id, err);
              return 0;
            }
          })
        );
        const totalAttendees = attendeesByEvent.reduce((sum, num) => sum + num, 0);
        setStats({
          myEvents: myCreatedEvents.length,
          attendees: totalAttendees,
          partners: uniquePartners.size,
          tasks: tasksInMyEvents,
        });

        // Fetch Users in system + add placeholders from events/team (for non-onboarded users)
        const usersSnap = await getDocs(collection(db, "users"));
        const usersFromDb = usersSnap.docs.map(u => ({ id: u.id, ...u.data() } as any));
        const existingEmails = new Set(
          usersFromDb
            .map(u => normalizeKey((u as any).email))
            .filter(Boolean)
        );
        const placeholders: { id: string; fullName?: string; email?: string; role?: string }[] = [];
        const addPlaceholderUser = (email?: string, name?: string) => {
          const key = normalizeKey(email);
          if (!key || existingEmails.has(key)) return;
          existingEmails.add(key);
          placeholders.push({
            id: `placeholder-${key}`,
            email: email || "",
            fullName: name || email || "משתמש ללא שם",
            role: "לא השלימו הרשמה",
          });
        };
        allEventsData.forEach(ev => {
          addPlaceholderUser(ev.createdByEmail, (ev as any).creatorName);
          const teamArr = (ev as any).team as { email?: string; name?: string }[] | undefined;
          (teamArr || []).forEach(m => addPlaceholderUser(m.email, m.name));
        });
        setUsersList([...usersFromDb, ...placeholders]);

        // Fetch volunteers from all events
        try {
          const volunteersData: { id: string; name?: string; firstName?: string; lastName?: string; email?: string; phone?: string; phoneNormalized?: string; eventId: string; eventTitle?: string; createdAt?: any; scope?: "event" | "project"; program?: string; year?: string; idNumber?: string; totalHours?: number }[] = [];
          const eventTitleMap = new Map(allEventsData.map(e => [e.id, e.title || "אירוע ללא שם"]));
          const projectTitleMap = new Map(allProjectsData.map(p => [p.id, (p as any).name || (p as any).title || "פרויקט ללא שם"]));
          const seenVolunteers = new Set<string>();
          const emailIndex = new Map<string, number>();
          const phoneIndex = new Map<string, number>();
          const normalizeLower = (val?: string) => (val || "").toString().trim().toLowerCase();
          const normalizePhone = (val?: string) => {
            const digits = (val || "").toString().replace(/\D/g, "");
            if (!digits) return "";
            if (digits.startsWith("972")) return digits;
            if (digits.startsWith("0")) return `972${digits.slice(1)}`;
            return digits;
          };
          const mergeVolunteerFields = (target: any, src: any) => ({
            ...target,
            name: (target.name && target.name.trim() !== "מתנדב ללא שם") ? target.name : (src.name || target.name),
            firstName: target.firstName || src.firstName,
            lastName: target.lastName || src.lastName,
            email: target.email || src.email,
            phone: target.phone || src.phone,
            phoneNormalized: target.phoneNormalized || src.phoneNormalized || normalizePhone(src.phone),
            program: target.program || src.program,
            year: target.year || src.year,
            idNumber: target.idNumber || src.idNumber,
            createdAt: target.createdAt || src.createdAt,
            eventId: target.eventId || src.eventId,
            eventTitle: target.eventTitle || src.eventTitle,
            scope: target.scope || src.scope,
          });
          const addVolunteer = (volDoc: any, eventId: string, volData: any, eventTitle?: string, scope: "event" | "project" = "event") => {
            const key = `${scope}-${eventId}-${volDoc.id}`;
            if (seenVolunteers.has(key)) return;
            seenVolunteers.add(key);

            // Extract name - try multiple formats
            let volunteerName = "";
            if (volData.name && typeof volData.name === "string" && volData.name.trim()) {
              volunteerName = volData.name.trim();
            } else if (volData.firstName || volData.lastName) {
              volunteerName = `${volData.firstName || ""} ${volData.lastName || ""}`.trim();
            } else if (volData.email) {
              // Use email as fallback
              volunteerName = volData.email.split("@")[0];
            }

            if (!volunteerName) {
              console.warn("Volunteer without name:", { volId: volDoc.id, volData, eventId });
              volunteerName = "מתנדב ללא שם";
            }

            const emailKey = normalizeLower(volData.email);
            const phoneKey = normalizePhone(volData.phone);
            let existingIdx = -1;
            if (emailKey && emailIndex.has(emailKey)) existingIdx = emailIndex.get(emailKey)!;
            else if (phoneKey && phoneIndex.has(phoneKey)) existingIdx = phoneIndex.get(phoneKey)!;

            const baseData = {
              id: volDoc.id,
              name: volunteerName,
              firstName: volData.firstName || "",
              lastName: volData.lastName || "",
              email: volData.email || "",
              phone: volData.phone || "",
              phoneNormalized: normalizePhone(volData.phone),
              eventId: eventId,
              eventTitle: eventTitleMap.get(eventId) || projectTitleMap.get(eventId) || eventTitle || (scope === "project" ? "פרויקט ללא שם" : "אירוע ללא שם"),
              createdAt: volData.createdAt,
              scope,
              program: volData.program || "",
              year: volData.year || "",
              idNumber: volData.idNumber || "",
            };

            if (existingIdx >= 0) {
              volunteersData[existingIdx] = mergeVolunteerFields(volunteersData[existingIdx], baseData);
              if (emailKey) emailIndex.set(emailKey, existingIdx);
              if (phoneKey) phoneIndex.set(phoneKey, existingIdx);
            } else {
              volunteersData.push(baseData);
              const idx = volunteersData.length - 1;
              if (emailKey) emailIndex.set(emailKey, idx);
              if (phoneKey) phoneIndex.set(phoneKey, idx);
            }
          };

          try {
            const volunteersQuery = query(collectionGroup(db, "volunteers"));
            const volunteersSnapshot = await getDocs(volunteersQuery);

            volunteersSnapshot.forEach((volDoc) => {
              const volData = volDoc.data();
              const eventId = volDoc.ref.parent.parent?.id || "";

              // Check if parent is an event or project
              const parentPath = volDoc.ref.parent.parent?.path || "";
              const isEventVolunteer = parentPath.startsWith("events/") || parentPath.includes("/events/");
              const isProjectVolunteer = parentPath.startsWith("projects/") || parentPath.includes("/projects/");
              if (isEventVolunteer) {
                addVolunteer(volDoc, eventId, volData, undefined, "event");
              } else if (isProjectVolunteer) {
                addVolunteer(volDoc, eventId, volData, undefined, "project");
              }
            });

            console.log(`Loaded ${volunteersData.length} volunteers from events via collectionGroup`, volunteersData.length > 0 ? volunteersData.slice(0, 3) : "No volunteers found");
          } catch (eventsVolunteersError) {
            console.error("Error loading volunteers from events:", eventsVolunteersError);
          }

          // General volunteers (global sign-up)
          try {
            const generalSnap = await getDocs(collection(db, "general_volunteers"));
            generalSnap.forEach((volDoc) => {
              const volData = volDoc.data();
              // Build name
              let volunteerName = "";
              if (volData.name && typeof volData.name === "string" && volData.name.trim()) {
                volunteerName = volData.name.trim();
              } else if (volData.firstName || volData.lastName) {
                volunteerName = `${volData.firstName || ""} ${volData.lastName || ""}`.trim();
              } else if (volData.email) {
                volunteerName = volData.email.split("@")[0];
              } else {
                volunteerName = "מתנדב ללא שם";
              }
              const fakeDoc = { id: volDoc.id };
              addVolunteer(fakeDoc, "general", { ...volData, name: volunteerName }, "הרשמה כללית", "event");
            });
          } catch (err) {
            console.error("Error loading general volunteers", err);
          }

          // Always also fetch per-event to include legacy/missing docs
          console.log("Loading volunteers from events individually (merge + dedup)...");
          for (const event of allEventsData) {
            try {
              const eventVolunteersSnap = await getDocs(collection(db, "events", event.id, "volunteers"));
              eventVolunteersSnap.forEach((volDoc) => {
                const volData = volDoc.data();
                addVolunteer(volDoc, event.id, volData, event.title, "event");
              });
            } catch (eventError) {
              console.error(`Error loading volunteers for event ${event.id}:`, eventError);
            }
          }
          console.log("Loading volunteers from projects individually (merge + dedup)...");
          for (const project of allProjectsData) {
            try {
              const projectVolunteersSnap = await getDocs(collection(db, "projects", project.id, "volunteers"));
              projectVolunteersSnap.forEach((volDoc) => {
                const volData = volDoc.data();
                const projTitle = (project as any).name || (project as any).title;
                addVolunteer(volDoc, project.id, volData, projTitle, "project");
              });
            } catch (projectError) {
              console.error(`Error loading volunteers for project ${project.id}:`, projectError);
            }
          }
          console.log(`Loaded ${volunteersData.length} volunteers total after merging per-event/project fetches`);

          // Aggregate volunteered hours from completions (for sorting by hours desc)
          try {
            const hoursByKey = new Map<string, number>();
            const completionsSnap = await getDocs(collection(db, "volunteer_completions"));
            completionsSnap.forEach((docSnap) => {
              const data = docSnap.data() as any;
              const emailKey = normalizeLower(data.email);
              const phoneKey = normalizePhone(data.phone || "");
              const h = Number(data.volunteerHours);
              if (!Number.isFinite(h) || h <= 0) return;
              const key = emailKey || phoneKey;
              if (!key) return;
              hoursByKey.set(key, (hoursByKey.get(key) || 0) + h);
            });
            volunteersData.forEach((vol, idx) => {
              const key = normalizeLower(vol.email) || vol.phoneNormalized || normalizePhone(vol.phone);
              const totalHours = key ? hoursByKey.get(key) || 0 : 0;
              volunteersData[idx] = { ...vol, totalHours };
            });
          } catch (err) {
            console.warn("Failed aggregating volunteer hours", err);
          }

          // Sort: hours desc, then newest createdAt
          const ts = (val: any) => {
            if (!val) return 0;
            if (typeof val.seconds === "number") return val.seconds;
            if (val instanceof Date) return Math.floor(val.getTime() / 1000);
            const parsed = Date.parse(val);
            return Number.isFinite(parsed) ? Math.floor(parsed / 1000) : 0;
          };
          volunteersData.sort((a, b) => {
            const hA = a.totalHours || 0;
            const hB = b.totalHours || 0;
            if (hB !== hA) return hB - hA;
            return ts(b.createdAt) - ts(a.createdAt);
          });

          setVolunteersList(volunteersData);
          // Registrants (event guest registrations) - admin only
          if (isAdmin) {
            try {
              const regsQuery = query(collectionGroup(db, "registrants"));
              const regsSnap = await getDocs(regsQuery);
              const regs: EventRegistrant[] = [];
              regsSnap.forEach((rDoc) => {
                const data = rDoc.data() as any;
                const parentId = rDoc.ref.parent.parent?.id || "";
                const regEventTitle = eventTitleMap.get(parentId) || (data.eventTitle as string) || "אירוע";
                regs.push({
                  id: rDoc.id,
                  name: data.name || data.fullName || data.firstName || "",
                  email: data.email || "",
                  phone: data.phone || "",
                  eventId: parentId,
                  eventTitle: regEventTitle,
                  createdAt: data.createdAt,
                });
              });
              regs.sort((a, b) => ts(b.createdAt) - ts(a.createdAt));
              setRegistrantsList(regs);
            } catch (err) {
              console.error("Error loading registrants", err);
              setRegistrantsList([]);
            }
            setLoadingRegistrants(false);
          }

          // Load all events for register modal editing/selection
          try {
            const allEventsSnap = await getDocs(collection(db, "events"));
            const allEv: any[] = [];
            const byId = new Map<string, any>();
            allEventsSnap.forEach(d => {
              const data = d.data() as any;
              const item = {
                id: d.id,
                title: data.title || "אירוע ללא שם",
                description: data.description || data.goal || "",
                location: data.location || "",
                startTime: data.startTime,
                officialFlyerUrl: data.officialFlyerUrl || data.previewImage || "",
                createdBy: data.createdBy,
                members: data.members || [],
                team: data.team || [],
              };
              allEv.push(item);
              byId.set(d.id, item);
            });
            // default selection if not saved
            const cfgRef = doc(db, "settings", "public_register_events");
            const cfgSnap = await getDoc(cfgRef);
            const allowed: string[] = cfgSnap.exists() ? (cfgSnap.data() as any).allowedEventIds || [] : [];
            const allowedSet = new Set<string>(allowed);
            if (allowedSet.size === 0) {
              allEv.forEach(ev => {
                const hasAdmin =
                  (ev.createdBy === user.uid) ||
                  (Array.isArray(ev.members) && ev.members.includes(user.uid)) ||
                  ((ev.team || []).some((m: any) => (m.userId && m.userId === user.uid) || (m.email && m.email.toLowerCase() === (user.email || "").toLowerCase())));
                if (hasAdmin) allowedSet.add(ev.id);
              });
            }
            // Ensure allowed events are present even אם לא נטענו ברשימה
            const missingAllowed = Array.from(allowedSet).filter(id => !byId.has(id));
            for (const mid of missingAllowed) {
              try {
                const docSnap = await getDoc(doc(db, "events", mid));
                if (docSnap.exists()) {
                  const data = docSnap.data() as any;
                  const item = {
                    id: docSnap.id,
                    title: data.title || "אירוע ללא שם",
                    description: data.description || data.goal || "",
                    location: data.location || "",
                    startTime: data.startTime,
                    officialFlyerUrl: data.officialFlyerUrl || data.previewImage || "",
                    createdBy: data.createdBy,
                    members: data.members || [],
                    team: data.team || [],
                  };
                  allEv.push(item);
                  byId.set(item.id, item);
                }
              } catch (err) {
                console.warn("Failed loading allowed event", mid, err);
              }
            }
            setRegisterEventsAll(allEv);
            setRegisterEventsSelection(allowedSet);
          } catch (err) {
            console.error("Error loading events for register selection", err);
          }

        } catch (volunteersError) {
          console.error("Error loading volunteers:", volunteersError);
          setVolunteersList([]);
          setRegistrantsList([]);
          setLoadingRegistrants(false);
        }

        // Fetch join requests of current user to show pending/approved
        const myJoinRequestsSnap = await getDocs(query(
          collection(db, "join_requests"),
          where("requesterId", "==", user.uid)
        ));
        const reqMap: Record<string, "PENDING" | "APPROVED" | "REJECTED"> = {};
        myJoinRequestsSnap.forEach(r => {
          const data = r.data() as any;
          if (data.eventId && data.status) {
            reqMap[data.eventId] = data.status;
          }
        });
        setJoinRequests(reqMap);

        // Join requests directed to me as בעל אירוע
        const incomingByOwnerId = await getDocs(query(collection(db!, "join_requests"), where("ownerId", "==", user.uid)));
        let incomingByEmail: any = null;
        if (user.email) {
          incomingByEmail = await getDocs(query(collection(db!, "join_requests"), where("ownerEmail", "==", user.email)));
        }
        const incomingCombined: Record<string, JoinRequest> = {};
        incomingByOwnerId.forEach(d => { incomingCombined[d.id] = { id: d.id, ...d.data() } as JoinRequest; });
        (incomingByEmail?.docs || []).forEach((d: any) => { incomingCombined[d.id] = { id: d.id, ...d.data() } as JoinRequest; });
        setIncomingJoinRequests(Object.values(incomingCombined).filter(r => r.status === "PENDING"));

      } catch (error) {
        console.error("Error fetching data:", error);
        setUsersError("שגיאה בטעינת משתמשים");
      } finally {
        setLoadingEvents(false);
        setLoadingProjects(false);
        setLoadingTasks(false);
        setLoadingStats(false);
        setLoadingUsers(false);
        setLoadingVolunteers(false);
        setLoadingNotifications(false);
      }
    };

    if (user) {
      fetchData();
    }
  }, [user]);

  // Load completion approval requests for task owners
  useEffect(() => {
    if (!db || !user) {
      setCompletionRequests([]);
      setShowRequestsModal(false);
      return;
    }
    const normEmail = (user.email || "").trim().toLowerCase();
    const unsubscribers: (() => void)[] = [];
    const mergeAndSet = (snapArr: any[]) => {
      const map = new Map<string, any>();
      snapArr.forEach(s => s.forEach((d: any) => map.set(d.id, d)));
      const arr = Array.from(map.values());
      setCompletionRequests(arr);
      setShowRequestsModal(arr.length > 0);
    };
    const snaps: any[] = [];
    const q1 = query(collection(db, "task_completion_requests"), where("status", "==", "PENDING"), where("ownerId", "==", user.uid));
    const unsub1 = onSnapshot(q1, (snap) => {
      snaps[0] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      mergeAndSet(snaps);
    });
    unsubscribers.push(unsub1);
    if (normEmail) {
      const q2 = query(collection(db, "task_completion_requests"), where("status", "==", "PENDING"), where("ownerEmail", "==", normEmail));
      const unsub2 = onSnapshot(q2, (snap) => {
        snaps[1] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        mergeAndSet(snaps);
      });
      unsubscribers.push(unsub2);
    }
    return () => {
      unsubscribers.forEach(u => u && u());
    };
  }, [db, user]);

  // Filter and sort tasks
  let filteredTasks = myTasks.filter(task => {
    if (filterEvent !== "all" && task.eventId !== filterEvent) return false;
    return true;
  });

  // Apply sorting
  if (sortBy !== "none") {
    filteredTasks = [...filteredTasks].sort((a, b) => {
      switch (sortBy) {
        case "deadline":
          // Sort by deadline (closest first)
          if (!a.dueDate) return 1;
          if (!b.dueDate) return -1;
          return new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime();

        case "priority":
          // Sort by priority (CRITICAL > HIGH > NORMAL)
          const priorityOrder = { CRITICAL: 0, HIGH: 1, NORMAL: 2 };
          return priorityOrder[a.priority] - priorityOrder[b.priority];

        case "status":
          // Sort by status (STUCK > IN_PROGRESS > TODO > DONE)
          const statusOrder = { STUCK: 0, IN_PROGRESS: 1, TODO: 2, DONE: 3 };
          return statusOrder[a.status] - statusOrder[b.status];

        case "eventDate":
          // Sort by event start time (we need to get this from events array)
          const eventA = events.find(e => e.id === a.eventId);
          const eventB = events.find(e => e.id === b.eventId);
          if (!eventA?.startTime) return 1;
          if (!eventB?.startTime) return -1;
          return eventA.startTime.seconds - eventB.startTime.seconds;

        case "created":
          // Sort by creation date (newest first) - we don't have this field, so skip
          return 0;

        default:
          return 0;
      }
    });
  }

  const currentUid = user?.uid || "";
  const taskNotifications = currentUid
    ? notificationTasks.filter(t => {
      const hasNewMessage = t.lastMessageTime && t.lastMessageBy && t.lastMessageBy !== currentUid;
      const unread = !t.readBy || !t.readBy[currentUid];
      const mentioned = (t as any).lastMessageMentions?.some((m: any) =>
        (m?.userId && m.userId === currentUid) ||
        (m?.email && user?.email && m.email.toLowerCase() === user.email.toLowerCase())
      );
      return (hasNewMessage && unread) || mentioned;
    })
    : [];

  const handleUpdateTask = async (e: React.FormEvent) => {
    // existing update logic for full task edit
    e.preventDefault();
    if (!db || !editingTask) return;
    try {
      const taskRef = editingTask.scope === "project"
        ? doc(db, "projects", editingTask.eventId, "tasks", editingTask.id)
        : doc(db, "events", editingTask.eventId, "tasks", editingTask.id);
      await updateDoc(taskRef, {
        title: editingTask.title,
        dueDate: editingTask.dueDate,
        priority: editingTask.priority,
        currentStatus: editingTask.currentStatus || "",
        nextStep: editingTask.nextStep || "",
      });
      setMyTasks(prev => prev.map(t => t.id === editingTask.id ? editingTask : t));
      setEditingTask(null);
    } catch (err) {
      console.error("Error updating task:", err);
      alert("שגיאה בעדכון המשימה");
    }
  };


  const handleDeleteTask = async () => {
    if (!db || !deletingTaskId) return;

    const taskToComplete = myTasks.find(t => t.id === deletingTaskId);
    if (!taskToComplete) return;

    try {
      const taskRef = taskToComplete.scope === "project"
        ? doc(db, "projects", taskToComplete.eventId, "tasks", deletingTaskId)
        : doc(db, "events", taskToComplete.eventId, "tasks", deletingTaskId);
      const required = taskToComplete.requiredCompletions != null
        ? Math.max(1, Number(taskToComplete.requiredCompletions))
        : 1;
      const remaining = taskToComplete.remainingCompletions != null
        ? Math.max(0, Number(taskToComplete.remainingCompletions))
        : required;
      if (required > 1) {
        const nextRemaining = Math.max(remaining - 1, 0);
        const nextStatus = nextRemaining > 0 ? "IN_PROGRESS" : "DONE";
        await updateDoc(taskRef, { status: nextStatus, remainingCompletions: nextRemaining });
        setMyTasks(prev => nextStatus === "DONE"
          ? prev.filter(t => t.id !== deletingTaskId)
          : prev.map(t => t.id === deletingTaskId ? { ...t, status: nextStatus, remainingCompletions: nextRemaining } : t));
        if (nextRemaining > 0) {
          alert(`סימנת ביצוע. נותרו עוד ${nextRemaining} מתוך ${required}.`);
        }
        setDeletingTaskId(null);
        return;
      }
      await updateDoc(taskRef, { status: "DONE" });

      // Remove from local view (DONE tasks are hidden)
      setMyTasks(prev => prev.filter(t => t.id !== deletingTaskId));
      setDeletingTaskId(null);
    } catch (err) {
      console.error("Error completing task via delete:", err);
      alert("שגיאה בסימון המשימה כהושלמה");
    }
  };

  const handleCompleteTask = async (task: Task) => {
    if (!db) return;

    try {
      const taskRef = task.scope === "project"
        ? doc(db, "projects", task.eventId, "tasks", task.id)
        : doc(db, "events", task.eventId, "tasks", task.id);
      const required = task.requiredCompletions != null
        ? Math.max(1, Number(task.requiredCompletions))
        : 1;
      const remaining = task.remainingCompletions != null
        ? Math.max(0, Number(task.remainingCompletions))
        : required;
      if (required > 1) {
        const nextRemaining = Math.max(remaining - 1, 0);
        const nextStatus = nextRemaining > 0 ? "IN_PROGRESS" : "DONE";
        await updateDoc(taskRef, {
          status: nextStatus,
          remainingCompletions: nextRemaining,
        });
        if (nextStatus === "DONE") {
          setMyTasks(prev => prev.filter(t => t.id !== task.id));
        } else {
          setMyTasks(prev => prev.map(t => t.id === task.id ? { ...t, status: nextStatus, remainingCompletions: nextRemaining } : t));
          alert(`סימנת ביצוע. נותרו עוד ${nextRemaining} מתוך ${required}.`);
        }
        return;
      }
      await updateDoc(taskRef, { status: "DONE" });

      // Remove from local state (since we filter out DONE tasks)
      setMyTasks(prev => prev.filter(t => t.id !== task.id));
    } catch (err) {
      console.error("Error completing task:", err);
      alert("שגיאה בסיום המשימה");
    }
  };

  const getVolunteerRef = (vol: VolunteerRecord) => {
    if (!db) throw new Error("Missing db");
    if (vol.eventId === "general" || vol.scope === "general") {
      return doc(db, "general_volunteers", vol.id);
    }
    return vol.scope === "project"
      ? doc(db, "projects", vol.eventId, "volunteers", vol.id)
      : doc(db, "events", vol.eventId, "volunteers", vol.id);
  };

  const resetManualTaskForm = () => {
    setManualTaskTitle("");
    setManualTaskHours("");
  };

  const closeVolunteerEditor = () => {
    setEditingVolunteer(null);
    resetManualTaskForm();
    setManualEventTitle("");
  };

  const startEditVolunteer = (vol: VolunteerRecord) => {
    setEditingVolunteer(vol);
    setEditVolunteerName(vol.name || "");
    setEditVolunteerEmail(vol.email || "");
    setEditVolunteerPhone(vol.phone || "");
    setManualEventTitle(vol.eventTitle || "");
    resetManualTaskForm();
  };

  const handleSendVolunteerWhatsapp = async (vol: VolunteerRecord) => {
    const phone = normalizePhoneValue(vol.phone || vol.phoneNormalized || "");
    if (!phone) {
      alert("לא נמצא מספר טלפון תקין למתנדב");
      return;
    }
    const defaultMsg = `היי ${vol.name || "מתנדב/ת"},`;
    const message = typeof window !== "undefined" ? window.prompt("הכנס/י את תוכן הודעת הוואטסאפ", defaultMsg) : null;
    if (!message || !message.trim()) return;
    try {
      const res = await fetch("/api/whatsapp/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone, message: message.trim() }),
      });
      const text = await res.text();
      if (!res.ok) throw new Error(text || `שליחה נכשלה (${res.status})`);
      alert("ההודעה נשלחה בוואטסאפ");
    } catch (err) {
      console.error("Failed sending volunteer WhatsApp", err);
      alert("שגיאה בשליחת הודעת הוואטסאפ");
    }
  };

  const handleSaveVolunteer = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!db || !editingVolunteer) return;
    const name = editVolunteerName.trim();
    const email = editVolunteerEmail.trim();
    const phone = editVolunteerPhone.trim();
    try {
      setSavingVolunteer(true);
      const ref = getVolunteerRef(editingVolunteer);
      const updateData: any = { email, phone };
      if (editingVolunteer.scope === "project") {
        const [firstName, ...rest] = name.split(" ");
        updateData.firstName = firstName || name;
        updateData.lastName = rest.join(" ").trim();
        updateData.name = name;
      } else {
        updateData.name = name;
      }
      await updateDoc(ref, updateData);
      setVolunteersList(prev =>
        prev.map(v =>
          v.id === editingVolunteer.id && v.eventId === editingVolunteer.eventId
            ? { ...v, name, email, phone }
            : v
        )
      );
      closeVolunteerEditor();
    } catch (err) {
      console.error("Error updating volunteer", err);
      alert("שגיאה בעדכון מתנדב");
    } finally {
      setSavingVolunteer(false);
    }
  };

  const submitManualCompletion = async (payload: ManualCompletionPayload, opts?: { suppressErrorLog?: boolean }) => {
    if (!db) {
      if (!opts?.suppressErrorLog) {
        recordVolunteerError({
          title: "הוספת משימה ידנית נכשלה",
          reason: "חיבור למסד הנתונים לא זמין",
          context: {
            volunteerEmail: payload.volunteerEmail,
            volunteerName: payload.volunteerName,
            eventTitle: payload.eventTitle,
            taskTitle: payload.taskTitle,
            scope: payload.scope || "event",
          },
          action: { type: "manual_completion", payload },
        });
      }
      return false;
    }
    try {
      const taskId = payload.taskId || `manual-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
      const volunteerHours = Number.isFinite(payload.volunteerHours) && payload.volunteerHours > 0 ? Number(payload.volunteerHours) : null;
      await addDoc(collection(db, "volunteer_completions"), {
        email: payload.volunteerEmail,
        name: payload.volunteerName,
        eventId: payload.eventId,
        eventTitle: payload.eventTitle || "",
        taskId,
        taskTitle: payload.taskTitle,
        volunteerHours,
        completedAt: serverTimestamp(),
        scope: payload.scope || "event",
      });
      return true;
    } catch (err) {
      console.error("Error adding manual completion:", err);
      if (!opts?.suppressErrorLog) {
        recordVolunteerError({
          title: "הוספת משימה ידנית נכשלה",
          reason: getErrorMessage(err),
          context: {
            volunteerEmail: payload.volunteerEmail,
            volunteerName: payload.volunteerName,
            eventTitle: payload.eventTitle,
            taskTitle: payload.taskTitle,
            scope: payload.scope || "event",
          },
          action: { type: "manual_completion", payload },
        });
      }
      return false;
    }
  };

  const handleAddManualCompletion = async () => {
    if (!editingVolunteer) return;
    const title = manualTaskTitle.trim();
    if (!title) {
      alert("יש להזין שם משימה.");
      return;
    }
    const hours = parseFloat(manualTaskHours);
    if (!Number.isFinite(hours) || hours <= 0) {
      alert("יש להזין מספר שעות חיובי.");
      return;
    }
    const volunteerEmail = (editVolunteerEmail.trim() || editingVolunteer.email || "").toLowerCase();
    if (!volunteerEmail) {
      alert("יש להזין אימייל כדי לשמור את המשימה.");
      return;
    }
    setManualSaving(true);
    let payload: ManualCompletionPayload | null = null;
    try {
      const eventTitle = manualEventTitle.trim() || editingVolunteer.eventTitle || "";
      payload = {
        volunteerEmail,
        volunteerName: editVolunteerName.trim() || editingVolunteer.name || "",
        eventId: editingVolunteer.eventId,
        eventTitle,
        taskTitle: title,
        volunteerHours: hours,
        scope: editingVolunteer.scope || "event",
        taskId: `manual-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
      };
      const ok = await submitManualCompletion(payload);
      if (!ok) {
        alert("שגיאה בהוספת המשימה הידנית. ראה פירוט בלוג השגיאות למטה.");
        return;
      }
      resetManualTaskForm();
      alert("המשימה נוספה לרישום שעות המתנדב.");
      if (viewVolunteer && viewVolunteer.email && viewVolunteer.email.toLowerCase() === volunteerEmail) {
        loadVolunteerTasks(viewVolunteer);
      }
    } catch (err) {
      console.error("Error adding manual completion:", err);
      recordVolunteerError({
        title: "הוספת משימה ידנית נכשלה",
        reason: getErrorMessage(err),
        context: {
          volunteerEmail,
          volunteerName: payload?.volunteerName || editingVolunteer.name || "",
          eventTitle: payload?.eventTitle || manualEventTitle || editingVolunteer.eventTitle,
          taskTitle: payload?.taskTitle || title,
          scope: payload?.scope || editingVolunteer.scope || "event",
        },
        action: {
          type: "manual_completion", payload: payload || {
            volunteerEmail,
            volunteerName: editVolunteerName.trim() || editingVolunteer.name || "",
            eventId: editingVolunteer.eventId,
            eventTitle: manualEventTitle.trim() || editingVolunteer.eventTitle || "",
            taskTitle: title,
            volunteerHours: hours,
            scope: editingVolunteer.scope || "event",
            taskId: payload?.taskId || undefined,
          }
        },
      });
      alert("שגיאה בהוספת המשימה הידנית.");
    } finally {
      setManualSaving(false);
    }
  };

  const handleDeleteVolunteer = async (vol?: { id: string; eventId: string; scope?: "event" | "project"; name?: string }) => {
    if (!db) return;
    const target = vol || confirmDeleteVolunteer;
    if (!target) return;
    try {
      setDeletingVolunteerId(`${target.scope || "event"}-${target.eventId}-${target.id}`);
      const ref = getVolunteerRef(target);
      await deleteDoc(ref);
      setVolunteersList(prev =>
        prev.filter(v => !(v.id === target.id && v.eventId === target.eventId && (v.scope || "event") === (target.scope || "event")))
      );
      setConfirmDeleteVolunteer(null);
    } catch (err) {
      console.error("Error deleting volunteer", err);
      alert("שגיאה במחיקת מתנדב");
    } finally {
      setDeletingVolunteerId(null);
    }
  };

  const loadVolunteerTasks = async (vol: { email?: string; name?: string }) => {
    if (!db || !vol.email) {
      setVolTasksPending([]);
      setVolTasksDone([]);
      setVolTasksHours(0);
      setVolTasksError("לא נמצא אימייל למתנדב, לכן לא ניתן לטעון משימות.");
      return;
    }
    setVolTasksError(null);
    const emailLower = vol.email.trim().toLowerCase();
    setLoadingVolTasks(true);
    try {
      const tasksSnap = await getDocs(collectionGroup(db, "tasks"));
      const pending: Task[] = [];
      const done: Task[] = [];
      let hours = 0;

      tasksSnap.forEach((docSnap) => {
        const data = docSnap.data() as any;
        const assignees = (data.assignees as { name?: string; email?: string; userId?: string }[] | undefined) || [];
        const assigneeEmail = (data.assigneeEmail || "").toString().toLowerCase();
        const match = assignees.some(a => (a.email || "").toLowerCase() === emailLower) || (assigneeEmail && assigneeEmail === emailLower);
        if (!match) return;
        const scope: "event" | "project" = docSnap.ref.parent.parent?.path?.includes("/projects/") ? "project" : "event";
        const parentId = docSnap.ref.parent.parent?.id || "";
        const task: Task = {
          id: docSnap.id,
          title: data.title || "משימה",
          description: data.description,
          assignee: data.assignee || assignees[0]?.name || "",
          assigneeId: data.assigneeId,
          assignees: assignees,
          status: data.status || "TODO",
          dueDate: data.dueDate,
          priority: data.priority || "NORMAL",
          currentStatus: data.currentStatus,
          nextStep: data.nextStep,
          eventId: parentId,
          eventTitle: data.eventTitle || (scope === "project" ? "פרויקט" : "אירוע"),
          scope,
          volunteerHours: data.volunteerHours ?? null,
        };
        if (task.status === "DONE") {
          done.push(task);
          const h = Number(task.volunteerHours);
          if (Number.isFinite(h) && h > 0) hours += h;
        } else {
          pending.push(task);
        }
      });

      const completionsSnap = await getDocs(query(
        collection(db, "volunteer_completions"),
        where("email", "==", emailLower)
      ));
      const seenDone = new Set(done.map(t => t.id));
      completionsSnap.forEach(c => {
        const d = c.data() as any;
        const taskId = d.taskId || "";
        if (!taskId || seenDone.has(taskId)) return;
        seenDone.add(taskId);
        const rawScope = (d.scope || d.eventScope || "").toString().toLowerCase();
        const scope: "event" | "project" =
          rawScope === "project"
            ? "project"
            : rawScope === "event"
              ? "event"
              : (d.eventId || "").startsWith("proj-") || (d.eventId || "").startsWith("project-")
                ? "project"
                : "event";
        const task: Task = {
          id: taskId,
          title: d.taskTitle || "משימה",
          description: "",
          assignee: vol.name || "",
          assigneeId: "",
          assignees: [{ name: vol.name || "", email: vol.email }],
          status: "DONE",
          dueDate: "",
          priority: "NORMAL",
          eventId: d.eventId || "",
          eventTitle: d.eventTitle || (scope === "project" ? "פרויקט" : "אירוע"),
          scope,
          volunteerHours: d.volunteerHours ?? null,
        };
        done.push(task);
        const h = Number(task.volunteerHours);
        if (Number.isFinite(h) && h > 0) hours += h;
      });

      setVolTasksPending(pending);
      setVolTasksDone(done);
      setVolTasksHours(hours);
    } catch (err) {
      console.error("Failed loading volunteer tasks", err);
      setVolTasksPending([]);
      setVolTasksDone([]);
      setVolTasksHours(0);
      setVolTasksError("שגיאה בטעינת המשימות למתנדב.");
    } finally {
      setLoadingVolTasks(false);
    }
  };

  const exportVolunteersToCsv = () => {
    if (typeof window === "undefined") return;
    if (!volunteersList || volunteersList.length === 0) {
      alert("אין מתנדבים לייצוא");
      return;
    }

    const headers = ["שם פרטי", "שם משפחה", "תעודת זהות", "נייד", "מייל", "חוג", "שנת לימודים"];
    const rows = volunteersList.map((vol) => {
      const nameParts = (vol.name || "").trim().split(/\s+/).filter(Boolean);
      const derivedFirst = vol.firstName || nameParts[0] || "";
      const derivedLast = vol.lastName || nameParts.slice(1).join(" ") || "";
      return [
        derivedFirst,
        derivedLast,
        vol.idNumber || "",
        vol.phone || "",
        vol.email || "",
        vol.program || "",
        vol.year || ""
      ];
    });

    const csvBody = [headers, ...rows]
      .map(row => row.map(cell => `"${(cell ?? "").toString().replace(/"/g, '""')}"`).join(","))
      .join("\n");
    // Add BOM so שהאקסל יזהה עברית נכון
    const csv = `\uFEFF${csvBody}`;

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.setAttribute("download", "volunteers.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const handleApproveJoinRequest = async (reqId: string) => {
    if (!db || !user) return;
    const req = incomingJoinRequests.find(r => r.id === reqId);
    if (!req || req.status !== "PENDING") return;
    try {
      const requesterName = req.requesterName || req.requesterEmail?.split("@")[0] || "חבר צוות";
      await Promise.all([
        updateDoc(doc(db, "events", req.eventId), {
          ...(req.requesterId ? { members: arrayUnion(req.requesterId) } : {}),
          team: arrayUnion({
            name: requesterName,
            role: "חבר צוות",
            email: req.requesterEmail || "",
            userId: req.requesterId || undefined
          })
        }),
        updateDoc(doc(db, "join_requests", req.id), { status: "APPROVED", respondedAt: serverTimestamp() })
      ]);
      setIncomingJoinRequests(prev => prev.map(r => r.id === reqId ? { ...r, status: "APPROVED" } : r));
    } catch (err) {
      console.error("Error approving join request:", err);
      alert("שגיאה באישור הבקשה");
    }
  };

  const handleRejectJoinRequest = async (reqId: string) => {
    if (!db || !user) return;
    const req = incomingJoinRequests.find(r => r.id === reqId);
    if (!req || req.status !== "PENDING") return;
    try {
      await updateDoc(doc(db, "join_requests", req.id), { status: "REJECTED", respondedAt: serverTimestamp() });
      setIncomingJoinRequests(prev => prev.map(r => r.id === reqId ? { ...r, status: "REJECTED" } : r));
    } catch (err) {
      console.error("Error rejecting join request:", err);
      alert("שגיאה בדחיית הבקשה");
    }
  };

  const handleLogout = async () => {
    try {
      if (auth) {
        await signOut(auth);
        router.push("/login");
      }
    } catch (err) {
      console.error("Error signing out:", err);
      alert("שגיאה בהתנתקות");
    }
  };

  const formatEventDate = (startTime: any) => {
    if (!startTime) return "";
    const date = startTime.seconds ? new Date(startTime.seconds * 1000) : new Date(startTime);
    if (isNaN(date.getTime())) return "";
    return date.toLocaleString("he-IL", { dateStyle: "short", timeStyle: "short" });
  };

  const formatProjectDueDate = (dueDate: any) => {
    if (!dueDate) return "";
    if (typeof dueDate === "string") return dueDate;
    if (dueDate?.seconds) {
      return new Date(dueDate.seconds * 1000).toLocaleDateString("he-IL");
    }
    return "";
  };

  const handleUpdateEventField = async (eventId: string, field: "startTime" | "location" | "participantsCount" | "status") => {
    if (!db) return;
    const event = events.find(e => e.id === eventId);
    if (!event) return;

    const current = field === "startTime"
      ? (event.startTime?.seconds ? new Date(event.startTime.seconds * 1000).toISOString().slice(0, 16) : "")
      : (event as any)[field] || "";

    const labelMap: Record<typeof field, string> = {
      startTime: "תאריך ושעה (פורמט: 2025-12-31T20:00)",
      location: "מיקום",
      participantsCount: "מספר משתתפים משוער",
      status: "סטטוס"
    };

    const input = window.prompt(`עדכן ${labelMap[field]}`, current);
    if (input === null) return; // cancel
    const trimmed = input.trim();

    let patch: any = {};
    if (field === "startTime") {
      const dt = new Date(trimmed);
      if (isNaN(dt.getTime())) {
        alert("תאריך/שעה לא תקינים");
        return;
      }
      patch.startTime = dt;
      patch.endTime = dt;
    } else {
      patch[field] = trimmed;
    }

    try {
      await updateDoc(doc(db, "events", eventId), patch);
      setEvents(prev => prev.map(e => e.id === eventId ? { ...e, ...patch } : e));
    } catch (err) {
      console.error("Error updating event field:", err);
      alert("שגיאה בעדכון האירוע");
    }
  };

  const deleteAllTasksFor = async (type: "events" | "projects", id: string) => {
    try {
      const tasksSnap = await getDocs(collection(db!, type, id, "tasks"));
      await Promise.all(tasksSnap.docs.map(d => deleteDoc(d.ref).catch(err => console.error("Error deleting task doc", err))));
    } catch (err) {
      console.error(`Error deleting tasks for ${type}/${id}`, err);
    }
  };

  const handleDeleteEvent = async (eventId: string) => {
    if (!db || !user) return;
    const ev = events.find(e => e.id === eventId);
    const isOwner = ev && (
      (ev.createdBy && ev.createdBy === user.uid) ||
      (ev.createdByEmail && user.email && normalizeKey(ev.createdByEmail) === normalizeKey(user.email))
    );
    if (!isOwner) {
      alert("רק יוצר האירוע יכול למחוק אותו.");
      setConfirmingEventId(null);
      return;
    }
    try {
      await deleteAllTasksFor("events", eventId);
      await deleteDoc(doc(db, "events", eventId));
      setEvents(prev => prev.filter(e => e.id !== eventId));
      setMyTasks(prev => prev.filter(t => t.eventId !== eventId));
      setNotificationTasks(prev => prev.filter(t => t.eventId !== eventId));
      setConfirmingEventId(null);
      setDeleteEventRemoveTasks(false);
    } catch (err) {
      console.error("Error deleting event:", err);
      alert("שגיאה במחיקת האירוע");
    }
  };

  const handleDeleteProject = async (projectId: string) => {
    if (!db || !user) return;
    const proj = projects.find(p => p.id === projectId);
    if (!proj || !isProjectOwner(proj, user)) {
      alert("רק יוצר הפרויקט יכול למחוק אותו.");
      setConfirmingProjectId(null);
      return;
    }
    try {
      await deleteAllTasksFor("projects", projectId);
      await deleteDoc(doc(db, "projects", projectId));
      setProjects(prev => prev.filter(p => p.id !== projectId));
      setProjectIndex(prev => {
        const next = { ...prev };
        delete next[projectId];
        return next;
      });
      setMyTasks(prev => prev.filter(t => !(t.scope === "project" && t.eventId === projectId)));
      setNotificationTasks(prev => prev.filter(t => !(t.scope === "project" && t.eventId === projectId)));
    } catch (err) {
      console.error("Error deleting project:", err);
      alert("שגיאה במחיקת הפרויקט");
    } finally {
      setConfirmingProjectId(null);
    }
  };

  const handleJoinEventRequest = async (eventObj: Event) => {
    if (!db || !user) return;
    const eventId = eventObj.id;
    if (eventObj.members?.includes(user.uid)) {
      alert("אתה כבר חלק מהצוות באירוע הזה");
      return;
    }
    if (joinRequests[eventId] === "PENDING") {
      alert("בקשה ממתינה לאישור מנהל האירוע");
      return;
    }
    try {
      await setDoc(doc(db, "join_requests", `${eventId}_${user.uid}`), {
        eventId,
        eventTitle: eventObj.title || "",
        requesterId: user.uid,
        requesterName: user.displayName || user.email?.split("@")[0] || "משתמש",
        requesterEmail: user.email || "",
        ownerId: eventObj.createdBy || "",
        ownerEmail: eventObj.createdByEmail || "",
        status: "PENDING",
        createdAt: serverTimestamp(),
      }, { merge: true });
      setJoinRequests(prev => ({ ...prev, [eventId]: "PENDING" }));
      alert("הבקשה נשלחה למנהל האירוע לאישור");
    } catch (err) {
      console.error("Error requesting to join event:", err);
      alert("שגיאה בשליחת בקשת ההצטרפות");
    }
  };

  const handleAddNote = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!db || !user) return;
    const text = newNote.trim();
    if (!text) return;
    try {
      const docRef = await addDoc(collection(db, "team_meeting_notes"), {
        text,
        createdBy: user.uid,
        createdByEmail: user.email || "",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });
      setTeamNotes(prev => [{ id: docRef.id, text, createdAt: { seconds: Math.floor(Date.now() / 1000) } }, ...prev]);
      setNewNote("");
    } catch (err) {
      console.error("Failed to add note", err);
    }
  };

  const handleDeleteNote = async (id: string) => {
    if (!db) return;
    try {
      await deleteDoc(doc(db, "team_meeting_notes", id));
      setTeamNotes(prev => prev.filter(n => n.id !== id));
    } catch (err) {
      console.error("Failed to delete note", err);
    }
  };

  const handleUpdateNote = async (id: string, text: string) => {
    if (!db) return;
    const trimmed = text.trim();
    if (!trimmed) return;
    try {
      await updateDoc(doc(db, "team_meeting_notes", id), { text: trimmed, updatedAt: serverTimestamp() });
      setTeamNotes(prev => prev.map(n => n.id === id ? { ...n, text: trimmed } : n));
      setEditingNoteId(null);
      setEditingNoteText("");
    } catch (err) {
      console.error("Failed to update note", err);
    }
  };

  const handleApproveCompletion = async (req: any, approve: boolean, opts?: { suppressErrorLog?: boolean }) => {
    if (!db) {
      if (!opts?.suppressErrorLog) {
        recordVolunteerError({
          title: "עדכון סטטוס משימת מתנדב נכשל",
          reason: "חיבור למסד הנתונים לא זמין",
          context: {
            volunteerEmail: req?.volunteerEmail,
            volunteerName: req?.volunteerName,
            eventTitle: req?.eventTitle || req?.eventId,
            taskTitle: req?.taskTitle,
            scope: req?.scope || "event",
          },
          action: { type: "approve_completion", approve, req },
        });
      }
      return false;
    }
    const requestRef = doc(db, "task_completion_requests", req.id);
    const isManualRequest = req.manualRequest === true || req.scope === "manual";
    let taskRef: ReturnType<typeof doc> | null = null;
    let taskData: any = null;
    if (!isManualRequest) {
      taskRef = req.scope === "project"
        ? doc(db, "projects", req.eventId, "tasks", req.taskId)
        : doc(db, "events", req.eventId, "tasks", req.taskId);
      try {
        const snap = await getDoc(taskRef);
        taskData = snap.exists() ? (snap.data() as any) : null;
      } catch (err) {
        console.warn("Failed loading task for completion approval", err);
      }
    }
    try {
      await updateDoc(requestRef, { status: approve ? "APPROVED" : "REJECTED", respondedAt: serverTimestamp() });
      if (!approve) {
        if (!isManualRequest && taskRef) {
          const required = taskData?.requiredCompletions != null ? Math.max(1, Number(taskData.requiredCompletions)) : 1;
          const completionsSnap = await getDocs(query(
            collection(db, "volunteer_completions"),
            where("taskId", "==", req.taskId)
          ));
          const completedCount = completionsSnap.docs.filter((docSnap) => {
            const data = docSnap.data() as any;
            return data.eventId === req.eventId;
          }).length;
          const nextStatus = completedCount >= required ? "DONE" : completedCount > 0 ? "IN_PROGRESS" : "TODO";
          await updateDoc(taskRef, {
            status: nextStatus,
            pendingApproval: false,
            pendingApprovalRequestId: "",
            lastApprovalDecision: "REJECTED",
          });
        }
      } else {
        if (!isManualRequest && taskRef) {
          const required = taskData?.requiredCompletions != null ? Math.max(1, Number(taskData.requiredCompletions)) : 1;
          const completionsSnap = await getDocs(query(
            collection(db, "volunteer_completions"),
            where("taskId", "==", req.taskId)
          ));
          const completedCount = completionsSnap.docs.filter((docSnap) => {
            const data = docSnap.data() as any;
            return data.eventId === req.eventId;
          }).length + 1;
          const nextStatus = completedCount >= required ? "DONE" : "IN_PROGRESS";
          await updateDoc(taskRef, {
            status: nextStatus,
            pendingApproval: false,
            pendingApprovalRequestId: "",
            lastApprovalDecision: "APPROVED",
          });
        }
        const completionEmail = (req.volunteerEmail || "").toLowerCase();
        const completionData: any = {
          email: completionEmail || req.volunteerEmail,
          name: req.volunteerName,
          eventId: req.eventId,
          eventTitle: req.eventTitle || "",
          scope: req.scope || (taskData?.scope as "event" | "project" | undefined) || "event",
          taskId: req.taskId,
          taskTitle: req.taskTitle || "משימה",
          completedAt: serverTimestamp(),
          notes: req.notes || "",
        };
        const hoursRaw = req.volunteerHours ?? (taskData?.volunteerHours ?? null);
        const parsedHours = hoursRaw != null ? Number(hoursRaw) : null;
        const volunteerHours = Number.isFinite(parsedHours) && parsedHours > 0 ? parsedHours : null;
        completionData.volunteerHours = volunteerHours;
        if (isManualRequest) {
          completionData.manualRequest = true;
        }
        await addDoc(collection(db, "volunteer_completions"), completionData);
      }
      setCompletionRequests(prev => {
        const next = prev.filter(r => r.id !== req.id);
        if (next.length === 0) setShowRequestsModal(false);
        return next;
      });
      return true;
    } catch (err) {
      console.error("Failed handling completion approval", err);
      if (!opts?.suppressErrorLog) {
        recordVolunteerError({
          title: "עדכון סטטוס משימת מתנדב נכשל",
          reason: getErrorMessage(err),
          context: {
            volunteerEmail: req?.volunteerEmail,
            volunteerName: req?.volunteerName,
            eventTitle: req?.eventTitle || req?.eventId,
            taskTitle: req?.taskTitle,
            scope: req?.scope || (taskData?.scope as "event" | "project" | undefined) || "event",
          },
          action: { type: "approve_completion", approve, req },
        });
      }
      alert("שגיאה בעדכון סטטוס המשימה");
      return false;
    }
  };

  const retryVolunteerError = async (entryId: string) => {
    const entry = volunteerErrorLog.find(e => e.id === entryId);
    if (!entry) return;
    setRetryingErrorIds(prev => ({ ...prev, [entryId]: true }));
    try {
      let ok = false;
      if (entry.action.type === "approve_completion") {
        ok = await handleApproveCompletion(entry.action.req, entry.action.approve, { suppressErrorLog: true });
      } else if (entry.action.type === "manual_completion") {
        ok = await submitManualCompletion(entry.action.payload, { suppressErrorLog: true });
      }
      if (ok) {
        setVolunteerErrorLog(prev => prev.filter(e => e.id !== entryId));
      } else {
        setVolunteerErrorLog(prev => prev.map(e => e.id === entryId ? { ...e, ts: Date.now() } : e));
      }
    } catch (err) {
      setVolunteerErrorLog(prev => prev.map(e => e.id === entryId ? { ...e, reason: getErrorMessage(err), ts: Date.now() } : e));
    } finally {
      setRetryingErrorIds(prev => {
        const next = { ...prev };
        delete next[entryId];
        return next;
      });
    }
  };

  const dismissVolunteerError = (entryId: string) => {
    setVolunteerErrorLog(prev => prev.filter(e => e.id !== entryId));
  };

  const openAssigneeWhatsapp = async (task: Task, assignee: { name?: string; email?: string; userId?: string; phone?: string }) => {
    const name = assignee?.name || assignee?.email || "מתנדב/ת";
    const origin = typeof window !== "undefined" ? window.location.origin : "";
    const taskLink = origin ? `${origin}/tasks/${task.id}${task.eventId ? `?eventId=${task.eventId}` : ""}` : "";
    const defaultMessage = [
      `היי ${name},`,
      `יש לך משימה: "${task.title}".`,
      task.eventTitle ? `אירוע/פרויקט: ${task.eventTitle}` : "",
      taskLink ? `קישור למשימה: ${taskLink}` : ""
    ].filter(Boolean).join("\n");

    setAssigneeWhatsappModal({
      taskId: task.id,
      taskTitle: task.title,
      eventTitle: task.eventTitle,
      assigneeName: name,
      assigneeEmail: assignee?.email,
      assigneeUserId: assignee?.userId,
      phone: assignee?.phone || "",
      message: defaultMessage,
      loadingPhone: !assignee?.phone && !!(assignee?.userId || assignee?.email),
      sending: false,
      error: null,
    });

    if (!assignee?.phone && (assignee?.userId || assignee?.email)) {
      const resolvedPhone = await resolveAssigneePhone(assignee);
      setAssigneeWhatsappModal(prev => prev && prev.taskId === task.id
        ? { ...prev, phone: resolvedPhone || prev.phone, loadingPhone: false }
        : prev);
    }
  };

  const handleSendAssigneeWhatsapp = async () => {
    if (!assigneeWhatsappModal) return;
    const cleanPhone = normalizePhoneValue(assigneeWhatsappModal.phone);
    if (!cleanPhone) {
      setAssigneeWhatsappModal(prev => prev ? { ...prev, error: "מספר טלפון לא תקין" } : prev);
      return;
    }
    if (!assigneeWhatsappModal.message.trim()) {
      setAssigneeWhatsappModal(prev => prev ? { ...prev, error: "יש להזין תוכן הודעה" } : prev);
      return;
    }
    setAssigneeWhatsappModal(prev => prev ? { ...prev, sending: true, error: null } : prev);
    try {
      const cfg = await fetchWhatsappConfig();
      if (!cfg?.idInstance || !cfg?.apiTokenInstance) {
        throw new Error("חסרות הגדרות וואטסאפ (idInstance/apiTokenInstance)");
      }
      const baseApi = (cfg.baseUrl || "https://api.green-api.com").replace(/\/$/, "");
      const endpoint = `${baseApi}/waInstance${cfg.idInstance}/SendMessage/${cfg.apiTokenInstance}`;
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chatId: `${cleanPhone}@c.us`, message: assigneeWhatsappModal.message }),
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "שליחה נכשלה");
      }
      alert("ההודעה נשלחה בוואטסאפ");
      setAssigneeWhatsappModal(null);
    } catch (err) {
      setAssigneeWhatsappModal(prev => prev ? { ...prev, sending: false, error: getErrorMessage(err) } : prev);
    }
  };

  const closeAssigneeWhatsappModal = () => setAssigneeWhatsappModal(null);

  if (loading) return <div className="p-8 text-center">טוען...</div>;
  if (!user) return null;

  return (
    <div className="min-h-screen p-6" style={{ background: 'var(--patifon-cream)' }}>
      <header className="flex justify-between items-start mb-8">
        <div className="flex flex-col items-start gap-2">
          <div className="flex items-center gap-2">
            <Link
              href="/settings"
              className="p-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100 transition"
              title="הגדרות"
            >
              <Settings size={20} />
            </Link>
            {isAdmin && (
              <Link
                href="/requests/inbox"
                className="relative p-2 rounded-full border border-gray-300 text-indigo-700 hover:bg-indigo-50 transition"
                title="בקשות לעריכה"
              >
                <FileEdit size={20} />
                {unreadEditRequests > 0 && (
                  <span className="absolute -top-1 -right-1 inline-flex h-3 w-3 rounded-full bg-red-500"></span>
                )}
              </Link>
            )}
            <button
              onClick={handleLogout}
              className="p-2 rounded-full border border-red-200 text-red-600 hover:bg-red-50 transition"
              title="התנתקות"
            >
              <LogOut size={20} />
            </button>
          </div>
          <h1 className="text-3xl font-bold leading-tight" style={{ color: 'var(--patifon-burgundy)' }}>
            {user.displayName || user.email}
          </h1>
        </div>
        <div className="flex items-center gap-3">
          {isProjectManager && (
            <Link
              href="/projects"
              className="px-4 py-2 rounded-lg border border-indigo-200 text-indigo-800 bg-indigo-50 hover:bg-indigo-100 transition flex items-center gap-2"
            >
              <FolderKanban size={18} />
              ניהול פרוייקטים
            </Link>
          )}
          <Link
            href="/events/new"
            className="patifon-gradient text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:opacity-90 transition vinyl-shadow"
          >
            <Plus size={20} />
            אירוע חדש
          </Link>
        </div>
      </header>

      {/* Task Chat Modal */}
      {chatTask && (
        <TaskChat
          eventId={chatTask.eventId}
          taskId={chatTask.id}
          taskTitle={chatTask.title}
          onClose={() => setChatTask(null)}
        />
      )}

      {/* Completion Approval Modal */}
      {showRequestsModal && completionRequests.length > 0 && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-2xl w-full p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h3 className="text-lg font-bold text-gray-900">אישורי משימות ממתנדבים</h3>
              <button onClick={() => setShowRequestsModal(false)} className="text-gray-500 hover:text-gray-700">
                <X size={18} />
              </button>
            </div>
            <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-1">
              {completionRequests.map((req) => {
                const requestTypeLabel = req.manualRequest
                  ? "דיווח ידני"
                  : req.scope === "project"
                    ? "פרויקט"
                    : "אירוע";
                return (
                  <div key={req.id} className="border border-gray-200 rounded-lg p-3 bg-white shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="font-semibold text-gray-900">{req.taskTitle || "משימה"}</p>
                        <p className="text-sm text-gray-600">אירוע/פרויקט: {req.eventTitle || req.eventId}</p>
                        <p className="text-sm text-gray-600">מתנדב: {req.volunteerName || req.volunteerEmail}</p>
                        {req.notes && (
                          <p className="text-xs text-gray-500 mt-1">הערות: {req.notes}</p>
                        )}
                      </div>
                      <span className="text-xs px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-100">{requestTypeLabel}</span>
                    </div>
                    <div className="flex gap-2 mt-3">
                      <button
                        onClick={() => handleApproveCompletion(req, true)}
                        className="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700"
                      >
                        אשר ביצוע
                      </button>
                      <button
                        onClick={() => handleApproveCompletion(req, false)}
                        className="px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm font-semibold hover:bg-red-700"
                      >
                        דחה
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {/* Event Delete Confirmation Modal */}
      {confirmingEventId && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-2">אישור מחיקת אירוע</h3>
            <p className="text-gray-600 mb-6">
              למחוק את האירוע הזה? פעולה זו תמחק את כל המשימות והנתונים הקשורים אליו.
            </p>
            <label className="flex items-center gap-2 mb-6 text-sm text-gray-700">
              <input
                type="checkbox"
                checked={deleteEventRemoveTasks}
                onChange={(e) => setDeleteEventRemoveTasks(e.target.checked)}
              />
              מחק גם את המשימות של האירוע מהרשימות שלי
            </label>
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setConfirmingEventId(null)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition"
              >
                ביטול
              </button>
              <button
                onClick={() => handleDeleteEvent(confirmingEventId)}
                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition shadow-sm"
              >
                מחק אירוע
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Project Delete Confirmation Modal */}
      {confirmingProjectId && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-2">אישור מחיקת פרויקט</h3>
            <p className="text-gray-600 mb-6">
              למחוק את הפרויקט הזה? המשימות שלו יימחקו והרשימות יוסרו ממסך הבית.
            </p>
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setConfirmingProjectId(null)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition"
              >
                ביטול
              </button>
              <button
                onClick={() => handleDeleteProject(confirmingProjectId)}
                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition shadow-sm"
              >
                מחק פרויקט
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Edit Task Modal */}
      {editingTask && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold">עריכת משימה</h3>
              <button onClick={() => setEditingTask(null)} className="text-gray-400 hover:text-gray-600">
                <X size={20} />
              </button>
            </div>
            <form onSubmit={handleUpdateTask} className="space-y-4">
              {/* title, dueDate, priority fields as before */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">כותרת</label>
                <input type="text" required className="w-full p-2 border rounded-lg text-sm" value={editingTask.title} onChange={e => setEditingTask({ ...editingTask, title: e.target.value })} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">תאריך יעד</label>
                <input type="date" className="w-full p-2 border rounded-lg text-sm" value={editingTask.dueDate} onChange={e => setEditingTask({ ...editingTask, dueDate: e.target.value })} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">עדיפות</label>
                <select className="w-full p-2 border rounded-lg text-sm" value={editingTask.priority} onChange={e => setEditingTask({ ...editingTask, priority: e.target.value as "NORMAL" | "HIGH" | "CRITICAL" })}>
                  <option value="NORMAL">רגיל</option>
                  <option value="HIGH">גבוה</option>
                  <option value="CRITICAL">דחוף</option>
                </select>
              </div>
              {/* New fields for status and next step */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">איפה זה עומד</label>
                <textarea className="w-full p-2 border rounded-lg text-sm" rows={2} placeholder="תאר את המצב הנוכחי..." value={editingTask.currentStatus || ""} onChange={e => setEditingTask({ ...editingTask, currentStatus: e.target.value })} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">הצעד הבא</label>
                <textarea className="w-full p-2 border rounded-lg text-sm" rows={2} placeholder="מה הצעד הבא..." value={editingTask.nextStep || ""} onChange={e => setEditingTask({ ...editingTask, nextStep: e.target.value })} />
              </div>
              <div className="flex justify-end gap-3 pt-4">
                <button type="button" onClick={() => setEditingTask(null)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium">ביטול</button>
                <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700">שמור שינויים</button>
              </div>
            </form>
          </div>
        </div>
      )}
      {/* Status Edit Modal */}
      {editingStatusTask && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold">עריכת סטטוס משימה</h3>
              <button onClick={() => setEditingStatusTask(null)} className="text-gray-400 hover:text-gray-600"><X size={20} /></button>
            </div>
            <form onSubmit={async (e) => {
              e.preventDefault();
              if (!db || !editingStatusTask) return;
              try {
                const taskRef = editingStatusTask.scope === "project"
                  ? doc(db, "projects", editingStatusTask.eventId, "tasks", editingStatusTask.id)
                  : doc(db, "events", editingStatusTask.eventId, "tasks", editingStatusTask.id);
                await updateDoc(taskRef, {
                  currentStatus: editingStatusTask.currentStatus || "",
                  nextStep: editingStatusTask.nextStep || "",
                  dueDate: editingStatusTask.dueDate,
                });
                setMyTasks(prev => prev.map(t => t.id === editingStatusTask.id ? editingStatusTask : t));
                setEditingStatusTask(null);
              } catch (err) {
                console.error("Error updating status:", err);
                alert("שגיאה בעדכון הסטטוס");
              }
            }} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">איפה זה עומד</label>
                <textarea className="w-full p-2 border rounded-lg text-sm" rows={2} value={editingStatusTask.currentStatus || ""} onChange={e => setEditingStatusTask({ ...editingStatusTask, currentStatus: e.target.value })} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">הצעד הבא</label>
                <textarea className="w-full p-2 border rounded-lg text-sm" rows={2} value={editingStatusTask.nextStep || ""} onChange={e => setEditingStatusTask({ ...editingStatusTask, nextStep: e.target.value })} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">תאריך יעד</label>
                <input type="date" className="w-full p-2 border rounded-lg text-sm" value={editingStatusTask.dueDate} onChange={e => setEditingStatusTask({ ...editingStatusTask, dueDate: e.target.value })} />
              </div>
              <div className="flex justify-end gap-3 pt-4">
                <button type="button" onClick={() => setEditingStatusTask(null)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium">ביטול</button>
                <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700">שמור שינויים</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal (marks task as done) */}
      {deletingTaskId && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-2">סיום משימה</h3>
            <p className="text-gray-600 mb-6">המשימה תסומן כהושלמה ותוסר מהרשימה שלך. להמשיך?</p>
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setDeletingTaskId(null)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition"
              >
                ביטול
              </button>
              <button
                onClick={handleDeleteTask}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition shadow-sm"
              >
                סמן כהושלמה
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* My Tasks Section */}
        <div className="bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
          <div className="flex items-center gap-2 mb-4">
            <CheckSquare style={{ color: 'var(--patifon-red)' }} />
            <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>המשימות שלי</h2>
            <span className="px-2 py-0.5 rounded-full text-xs font-medium" style={{ background: 'var(--patifon-yellow)', color: 'var(--patifon-burgundy)' }}>
              {filteredTasks.length}
            </span>
          </div>

          {/* Filters */}
          <div className="flex gap-2 mb-4 flex-wrap">
            <div className="flex items-center gap-2">
              <Filter size={16} className="text-gray-400" />
              <select
                value={filterEvent}
                onChange={(e) => setFilterEvent(e.target.value)}
                className="text-sm border border-gray-200 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
                <option value="all">כל האירועים</option>
                {events.map(event => (
                  <option key={event.id} value={event.id}>{event.title}</option>
                ))}
              </select>
            </div>

            <select
              value={sortBy}
              onChange={(e) => setSortBy(e.target.value)}
              className="text-sm border border-gray-200 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              <option value="none">ללא מיון</option>
              <option value="deadline">📅 לפי דד ליין (קרוב לרחוק)</option>
              <option value="priority">⚠️ לפי עדיפות (דחוף → רגיל)</option>
              <option value="status">🔄 לפי סטטוס (תקוע → בתהליך)</option>
              <option value="eventDate">🎉 לפי תאריך האירוע</option>
            </select>
          </div>

          {loadingTasks ? (
            <div className="text-gray-500 text-center py-8">טוען משימות...</div>
          ) : filteredTasks.length === 0 ? (
            <div className="text-gray-500 text-center py-8">
              {myTasks.length === 0 ? "אין משימות פתוחות כרגע." : "אין משימות התואמות לסינון."}
            </div>
          ) : (
            <div className="max-h-96 overflow-y-auto pr-1">
              <div className="space-y-3">
                {filteredTasks.map((task) => {
                  const hasUnread = task.lastMessageTime && (!task.readBy || !task.readBy[user?.uid || '']) && task.lastMessageBy !== user?.uid;
                  return (
                    <TaskCard
                      key={task.id}
                      id={task.id}
                      title={task.title}
                      description={task.description}
                      assignee={task.assignee || "לא משויך"}
                      assignees={task.assignees}
                      status={task.status}
                      dueDate={task.dueDate}
                      priority={task.priority}
                      currentStatus={task.currentStatus}
                      nextStep={task.nextStep}
                      eventId={task.eventId}
                      eventTitle={task.eventTitle}
                      scope={task.scope}
                      onEdit={() => setEditingTask(task)}
                      onDelete={() => setDeletingTaskId(task.id)}
                      onStatusChange={async (newStatus) => {
                        if (newStatus === "DONE") {
                          handleCompleteTask(task);
                        } else {
                          // Update status for other transitions
                          if (!db) return;
                          try {
                            const taskRef = task.scope === "project"
                              ? doc(db, "projects", task.eventId, "tasks", task.id)
                              : doc(db, "events", task.eventId, "tasks", task.id);
                            await updateDoc(taskRef, { status: newStatus });
                            setMyTasks(prev => prev.map(t => t.id === task.id ? { ...t, status: newStatus } : t));
                          } catch (err) {
                            console.error("Error updating status:", err);
                          }
                        }
                      }}
                      onChat={() => setChatTask(task)}
                      hasUnreadMessages={hasUnread}
                      onEditStatus={(t) => setEditingStatusTask({
                        ...t,
                        eventId: t.eventId || "",
                        eventTitle: t.eventTitle || "",
                        scope: task.scope
                      } as Task)}
                      onEditDate={(t) => setEditingDateTask({
                        ...t,
                        eventId: t.eventId || "",
                        eventTitle: t.eventTitle || "",
                        scope: task.scope
                      } as Task)}
                      onManageAssignees={() => {
                        // מוביל למסך פרטי המשימה עם רמז אירוע כדי לאפשר תיוג גם במובייל
                        router.push(`/tasks/${task.id}?eventId=${task.eventId}&focus=assignees`);
                      }}
                      onAssigneeClick={(assignee) => {
                        const target = assignee || { name: task.assignee, email: (task as any).assigneeEmail };
                        openAssigneeWhatsapp(task, target);
                      }}
                    />
                  );
                })}
              </div>
            </div>
          )}
        </div>

        {/* Active Events Section */}
        <div className="bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
          <div className="flex items-center gap-3 mb-2">
            <Calendar style={{ color: 'var(--patifon-orange)' }} />
            <div className="flex flex-col">
              <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>אירועים פעילים</h2>
              <span className="text-xs text-gray-600">
                משימות ללא שיוך (לא הוקצו ולא משימת מתנדב): {unassignedTasksCount}
              </span>
            </div>
          </div>
          {loadingEvents ? (
            <div className="text-gray-500 text-center py-8">טוען אירועים...</div>
          ) : events.length === 0 ? (
            <div className="text-gray-500 text-center py-8">
              אין אירועים פעילים.
            </div>
          ) : (
            <div className="space-y-3 max-h-96 overflow-y-auto pr-1">
              {events.map((event) => (
                <div
                  key={event.id}
                  className="flex items-start gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition"
                >
                  <Link href={`/events/${event.id}`} className="flex-1 min-w-0">
                    <h3 className="font-semibold text-gray-900 truncate">{event.title}</h3>
                    <div className="grid grid-cols-2 gap-2 mt-2 text-xs text-gray-600">
                      <button
                        type="button"
                        onClick={() => handleUpdateEventField(event.id, "startTime")}
                        className="flex items-center gap-1 min-w-0 text-left hover:text-indigo-700"
                        title="עדכון תאריך ושעה"
                      >
                        <Calendar size={14} className="shrink-0" />
                        <span className="truncate underline-offset-2">{formatEventDate(event.startTime) || "אין תאריך"}</span>
                      </button>
                      <button
                        type="button"
                        onClick={() => handleUpdateEventField(event.id, "location")}
                        className="flex items-center gap-1 min-w-0 text-left hover:text-indigo-700"
                        title="עדכון מיקום"
                      >
                        <MapPin size={14} className="shrink-0" />
                        <span className="truncate underline-offset-2">{event.location || "לא צוין מיקום"}</span>
                      </button>
                      <button
                        type="button"
                        onClick={() => handleUpdateEventField(event.id, "participantsCount")}
                        className="flex items-center gap-1 min-w-0 text-left hover:text-indigo-700"
                        title="עדכון כמות משתתפים"
                      >
                        <Users size={14} className="shrink-0" />
                        <span className="truncate underline-offset-2">{event.participantsCount || "משתתפים: לא צוין"}</span>
                      </button>
                      <button
                        type="button"
                        onClick={() => handleUpdateEventField(event.id, "status")}
                        className="flex items-center gap-1 min-w-0 text-left hover:text-indigo-700"
                        title="עדכון סטטוס"
                      >
                        <CheckSquare size={14} className="shrink-0" />
                        <span className="truncate underline-offset-2">{event.status || "ללא סטטוס"}</span>
                      </button>
                    </div>
                  </Link>
                  {(
                    (event.createdBy && event.createdBy === user.uid) ||
                    (event.createdByEmail && user.email && normalizeKey(event.createdByEmail) === normalizeKey(user.email))
                  ) && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          e.preventDefault();
                          setDeleteEventRemoveTasks(false);
                          setConfirmingEventId(event.id);
                        }}
                        className="p-2 rounded-full text-red-600 hover:text-red-700 hover:bg-red-50 border border-red-200 shrink-0"
                        title="מחק אירוע"
                      >
                        <Trash2 size={16} />
                      </button>
                    )}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Active Projects Section */}
      <div className="mt-8 bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
        <div className="flex items-center justify-between gap-2 mb-4">
          <div className="flex items-center gap-2">
            <FolderKanban style={{ color: 'var(--patifon-orange)' }} />
            <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>פרויקטים פעילים</h2>
          </div>
          <Link
            href="/projects?openForm=1"
            className="inline-flex items-center gap-2 rounded-lg border border-indigo-200 px-3 py-1.5 text-sm font-semibold text-indigo-700 hover:bg-indigo-50 transition"
            title="פתיחת פרויקט חדש עם אותו טופס של האדמין"
          >
            <Plus size={16} />
            פתיחת פרויקט חדש
          </Link>
        </div>
        {loadingProjects ? (
          <div className="text-gray-500 text-center py-8">טוען פרויקטים...</div>
        ) : projects.length === 0 ? (
          <div className="text-gray-500 text-center py-8">אין פרויקטים פעילים עבורך כרגע.</div>
        ) : (
          <div className="space-y-3 max-h-96 overflow-y-auto pr-1">
            {projects.map((project) => (
              <div
                key={project.id}
                className="flex items-start gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition"
              >
                <Link href={`/projects/${project.id}`} className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <h3 className="font-semibold text-gray-900 truncate">{project.name || "פרויקט ללא שם"}</h3>
                    {project.status && (
                      <span className="px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">
                        {project.status}
                      </span>
                    )}
                  </div>
                  {project.summary && (
                    <p className="text-sm text-gray-600 mt-1 truncate" title={project.summary}>
                      {project.summary}
                    </p>
                  )}
                  <div className="mt-2 flex items-center gap-3 text-xs text-gray-600 flex-wrap">
                    {project.goal && <span className="truncate" title={project.goal}>מטרה: {project.goal}</span>}
                    {formatProjectDueDate(project.dueDate) && (
                      <span className="flex items-center gap-1">
                        <Calendar size={14} className="shrink-0" />
                        יעד: {formatProjectDueDate(project.dueDate)}
                      </span>
                    )}
                  </div>
                </Link>
                {isProjectOwner(project, user) && (
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      e.preventDefault();
                      setConfirmingProjectId(project.id);
                    }}
                    className="p-2 rounded-full text-red-600 hover:text-red-700 hover:bg-red-50 border border-red-200 shrink-0"
                    title="מחק פרויקט"
                  >
                    <Trash2 size={16} />
                  </button>
                )}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Team Meeting Notes */}
      <div className="mt-8 bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
        <div className="flex items-center gap-2 mb-4">
          <MessageCircle style={{ color: 'var(--patifon-orange)' }} />
          <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>נקודות לפגישת הצוות הקרובה</h2>
        </div>
        <form onSubmit={handleAddNote} className="flex flex-col gap-3 md:flex-row md:items-center mb-4">
          <textarea
            className="flex-1 p-3 border rounded-lg text-sm border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="כתבו כאן נקודות, החלטות או שאלות לפגישה..."
            value={newNote}
            onChange={(e) => setNewNote(e.target.value)}
            rows={2}
          />
          <button
            type="submit"
            className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold hover:bg-indigo-700 transition"
          >
            הוסף
          </button>
        </form>
        {loadingNotes ? (
          <div className="text-gray-500 text-sm">טוען נקודות...</div>
        ) : teamNotes.length === 0 ? (
          <div className="text-gray-500 text-sm">אין נקודות עדיין. הוסף את הראשונה.</div>
        ) : (
          <div className="space-y-3">
            {teamNotes.map(note => (
              <div key={note.id} className="p-3 border border-gray-200 rounded-lg bg-gray-50">
                {editingNoteId === note.id ? (
                  <div className="space-y-2">
                    <textarea
                      className="w-full p-2 border rounded-lg text-sm"
                      rows={2}
                      value={editingNoteText}
                      onChange={(e) => setEditingNoteText(e.target.value)}
                    />
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => handleUpdateNote(note.id, editingNoteText)}
                        className="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-xs hover:bg-indigo-700"
                      >
                        שמור
                      </button>
                      <button
                        onClick={() => { setEditingNoteId(null); setEditingNoteText(""); }}
                        className="px-3 py-1.5 rounded-lg border border-gray-200 text-xs text-gray-700 hover:bg-gray-100"
                      >
                        בטל
                      </button>
                    </div>
                  </div>
                ) : (
                  <div className="flex items-start justify-between gap-3">
                    <p className="text-sm text-gray-800 whitespace-pre-wrap">{note.text}</p>
                    <div className="flex items-center gap-2 shrink-0">
                      <button
                        onClick={() => { setEditingNoteId(note.id); setEditingNoteText(note.text); }}
                        className="text-indigo-700 text-xs hover:underline"
                      >
                        ערוך
                      </button>
                      <button
                        onClick={() => handleDeleteNote(note.id)}
                        className="text-red-600 text-xs hover:underline"
                      >
                        מחק
                      </button>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="mt-8 flex justify-center gap-3 flex-wrap">
        <button
          onClick={() => setActivePanel(prev => prev === "stats" ? null : "stats")}
          className={`flex items-center gap-2 px-4 py-2 rounded-full border transition text-sm font-medium ${activePanel === "stats" ? "bg-indigo-50 border-indigo-200 text-indigo-700" : "bg-white border-gray-300 text-gray-700 hover:bg-gray-50"}`}
        >
          <BarChart3 size={18} />
          סטטיסטיקות
        </button>
        <button
          onClick={() => setActivePanel(prev => prev === "users" ? null : "users")}
          className={`flex items-center gap-2 px-4 py-2 rounded-full border transition text-sm font-medium ${activePanel === "users" ? "bg-indigo-50 border-indigo-200 text-indigo-700" : "bg-white border-gray-300 text-gray-700 hover:bg-gray-50"}`}
        >
          <Users size={18} />
          משתמשי מערכת
        </button>
        <button
          onClick={() => setActivePanel(prev => prev === "volunteers" ? null : "volunteers")}
          className={`flex items-center gap-2 px-4 py-2 rounded-full border transition text-sm font-medium ${activePanel === "volunteers" ? "bg-indigo-50 border-indigo-200 text-indigo-700" : "bg-white border-gray-300 text-gray-700 hover:bg-gray-50"}`}
        >
          <div className="relative flex items-center gap-2">
            <UserPlus size={18} />
            {completionRequests.length > 0 && (
              <span className="absolute -top-1 -right-2 h-3 w-3 rounded-full bg-red-500"></span>
            )}
            <span>מתנדבים רשומים</span>
          </div>
        </button>
        {isAdmin && (
          <button
            onClick={() => setActivePanel(prev => prev === "registrants" ? null : "registrants")}
            className={`flex items-center gap-2 px-4 py-2 rounded-full border transition text-sm font-medium ${activePanel === "registrants" ? "bg-indigo-50 border-indigo-200 text-indigo-700" : "bg-white border-gray-300 text-gray-700 hover:bg-gray-50"}`}
          >
            <Users size={18} />
            נרשמים לאירועים
          </button>
        )}
        <button
          onClick={() => setActivePanel(prev => prev === "notifications" ? null : "notifications")}
          className={`flex items-center gap-2 px-4 py-2 rounded-full border transition text-sm font-medium ${activePanel === "notifications" ? "bg-indigo-50 border-indigo-200 text-indigo-700" : "bg-white border-gray-300 text-gray-700 hover:bg-gray-50"}`}
        >
          <Bell size={18} />
          הודעות
        </button>
      </div>

      {showRegisterEventsModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg max-w-3xl w-full p-6 max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold text-gray-900">עריכת אירועים להרשמה</h3>
              <button onClick={() => setShowRegisterEventsModal(false)} className="text-gray-500 hover:text-gray-800">סגור</button>
            </div>
            <p className="text-sm text-gray-600 mb-3">בחר אילו אירועים יופיעו בדף הרשמה לאורחים. ברירת המחדל: כל אירוע שאדמין יצר או שותף בו.</p>
            <div className="mb-4 p-3 rounded-lg border border-indigo-100 bg-indigo-50/40">
              <div className="flex items-center justify-between gap-3 flex-wrap">
                <div className="flex flex-col">
                  <span className="text-sm font-semibold text-indigo-900">גלריית תמונות לדף ההרשמה</span>
                  <span className="text-xs text-gray-600">העלו תמונות שיוצגו בדף ההרשמה לאירועים. נשתמש בהן לעיצוב הדף.</span>
                </div>
                <div className="flex items-center gap-2">
                  <input
                    ref={registerGalleryInputRef}
                    type="file"
                    accept="image/*"
                    multiple
                    className="hidden"
                    onChange={(e) => {
                      const files = e.target.files ? Array.from(e.target.files) : [];
                      if (files.length) {
                        handleRegisterGalleryUpload(files);
                      }
                      if (e.target) {
                        e.target.value = "";
                      }
                    }}
                  />
                  <button
                    type="button"
                    onClick={() => registerGalleryInputRef.current?.click()}
                    disabled={!isAdmin || uploadingRegisterGallery}
                    className="px-3 py-1 rounded-lg text-xs font-semibold text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-60"
                  >
                    {uploadingRegisterGallery ? "מעלה..." : "העלה תמונות לגלריה"}
                  </button>
                </div>
              </div>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3">
                {loadingRegisterGallery ? (
                  <div className="col-span-full text-[11px] text-gray-600 text-center">טוען גלריה...</div>
                ) : registerGallery.length === 0 ? (
                  <div className="col-span-full text-[11px] text-gray-600 text-center">אין תמונות בגלריה עדיין.</div>
                ) : (
                  registerGallery.map((img) => (
                    <div key={img.id} className="relative border rounded-lg overflow-hidden bg-white flex flex-col">
                      <button
                        type="button"
                        onClick={() => handleDeleteRegisterGallery(img)}
                        disabled={deletingRegisterGalleryId === img.id}
                        className="absolute top-1 right-1 bg-white/90 text-red-600 border border-red-200 rounded-full px-2 text-[10px] font-semibold hover:bg-red-50 disabled:opacity-60"
                      >
                        {deletingRegisterGalleryId === img.id ? "מוחק..." : "מחק"}
                      </button>
                      {/* eslint-disable-next-line @next/next/no-img-element */}
                      {(() => {
                        const name = (img.name || "").toLowerCase();
                        const isHeic = name.endsWith(".heic") || name.endsWith(".heif");
                        if (isHeic) {
                          return (
                            <div className="w-full h-20 bg-gradient-to-br from-indigo-50 to-amber-50 flex flex-col items-center justify-center text-[10px] text-indigo-800 px-2">
                              <div className="font-semibold">פורמט HEIC</div>
                              <div className="text-[9px] text-gray-600 text-center">מומלץ להעלות JPG/PNG כדי שיוצג לציבור</div>
                            </div>
                          );
                        }
                        return <img src={img.url || ""} alt={img.name || "gallery"} className="w-full h-20 object-cover" />;
                      })()}
                      <div className="px-2 py-1 text-[10px] text-gray-600 truncate pr-10">{img.name || "תמונה"}</div>
                    </div>
                  ))
                )}
              </div>
              <div className="text-[11px] text-gray-600 mt-2">לתצוגה לציבור מומלץ JPG/PNG. קבצי HEIC יוצגו כהערה בלבד בדפדפנים שלא תומכים.</div>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
              {registerEventsAll.map(ev => {
                const checked = registerEventsSelection.has(ev.id);
                const edit = eventEdits[ev.id] || {};
                return (
                  <label key={ev.id} className={`border rounded-lg p-3 flex items-start gap-3 cursor-pointer transition ${checked ? "border-indigo-300 bg-indigo-50" : "border-gray-200 bg-white"}`}>
                    <input
                      type="checkbox"
                      className="mt-1"
                      checked={checked}
                      onChange={(e) => {
                        setRegisterEventsSelection(prev => {
                          const next = new Set(prev);
                          if (e.target.checked) next.add(ev.id);
                          else next.delete(ev.id);
                          return next;
                        });
                      }}
                    />
                    <div className="min-w-0 flex-1 space-y-2">
                      <div className="flex items-center gap-2">
                        <div className="w-14 h-14 rounded-lg bg-gray-100 border border-gray-200 overflow-hidden flex items-center justify-center">
                          {((edit.hero ?? ev.officialFlyerUrl) && (
                            // eslint-disable-next-line @next/next/no-img-element
                            <img src={(edit.hero ?? ev.officialFlyerUrl) as string} alt={ev.title} className="w-full h-full object-cover" />
                          )) || <span className="text-[10px] text-gray-500 px-1 text-center">אין תמונה</span>}
                        </div>
                        <div className="flex flex-col gap-1">
                          <input
                            type="file"
                            accept="image/*"
                            onChange={async (e) => {
                              const file = e.target.files?.[0];
                              if (!file || !db || !storage || !isAdmin) return;
                              setLoadingFilesFor(ev.id);
                              try {
                                const path = `events/${ev.id}/files/register-${Date.now()}-${file.name}`;
                                const storageRef = ref(storage, path);
                                await uploadBytes(storageRef, file);
                                const url = await getDownloadURL(storageRef);
                                await addDoc(collection(db, "events", ev.id, "files"), {
                                  name: file.name,
                                  url,
                                  storagePath: path,
                                  createdAt: serverTimestamp(),
                                });
                                setEventEdits(prev => ({ ...prev, [ev.id]: { ...prev[ev.id], hero: url } }));
                                setRegisterEventsAll(prev => prev.map(item => item.id === ev.id ? { ...item, officialFlyerUrl: url } : item));
                              } catch (err) {
                                console.error("Error uploading hero", err);
                                alert("שגיאה בהעלאת תמונה");
                              } finally {
                                setLoadingFilesFor(null);
                              }
                            }}
                            className="text-[11px]"
                          />
                          <button
                            type="button"
                            className="text-[11px] text-indigo-700 hover:underline"
                            onClick={async (e) => {
                              e.preventDefault();
                              if (!db) return;
                              setLoadingFilesFor(ev.id);
                              try {
                                const snap = await getDocs(query(collection(db, "events", ev.id, "files"), orderBy("createdAt", "desc"), limit(30)));
                                const files = snap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));
                                setEventFilesMap(prev => ({ ...prev, [ev.id]: files }));
                              } catch (err) {
                                console.error("Error loading event files", err);
                                alert("לא הצלחנו לטעון קבצים");
                              } finally {
                                setLoadingFilesFor(null);
                              }
                            }}
                          >
                            בחר ממאגר האירוע
                          </button>
                        </div>
                      </div>
                      <input
                        type="text"
                        className="w-full border rounded-lg px-2 py-1 text-sm"
                        value={edit.title ?? ev.title}
                        onChange={(e) => setEventEdits(prev => ({ ...prev, [ev.id]: { ...prev[ev.id], title: e.target.value } }))}
                        placeholder="כותרת"
                      />
                      <input
                        type="text"
                        className="w-full border rounded-lg px-2 py-1 text-sm"
                        value={edit.location ?? ev.location}
                        onChange={(e) => setEventEdits(prev => ({ ...prev, [ev.id]: { ...prev[ev.id], location: e.target.value } }))}
                        placeholder="מיקום"
                      />
                      <textarea
                        className="w-full border rounded-lg px-2 py-1 text-sm"
                        rows={2}
                        value={edit.description ?? ev.description}
                        onChange={(e) => setEventEdits(prev => ({ ...prev, [ev.id]: { ...prev[ev.id], description: e.target.value } }))}
                        placeholder="תיאור קצר"
                      />
                      <input
                        type="datetime-local"
                        className="w-full border rounded-lg px-2 py-1 text-sm"
                        value={edit.startTime ?? (ev.startTime?.seconds ? new Date(ev.startTime.seconds * 1000).toISOString().slice(0, 16) : (ev.startTime ? new Date(ev.startTime).toISOString().slice(0, 16) : ""))}
                        onChange={(e) => setEventEdits(prev => ({ ...prev, [ev.id]: { ...prev[ev.id], startTime: e.target.value } }))}
                      />
                      <input
                        type="text"
                        className="w-full border rounded-lg px-2 py-1 text-sm"
                        value={(edit.hero ?? ev.officialFlyerUrl) || ""}
                        onChange={(e) => setEventEdits(prev => ({ ...prev, [ev.id]: { ...prev[ev.id], hero: e.target.value } }))}
                        placeholder="קישור לתמונה"
                      />
                      {loadingFilesFor === ev.id && <div className="text-[11px] text-gray-500">טוען קבצים...</div>}
                      {eventFilesMap[ev.id] && eventFilesMap[ev.id].length > 0 && (
                        <div className="grid grid-cols-3 gap-2">
                          {eventFilesMap[ev.id].map(f => (
                            <button
                              key={f.id}
                              type="button"
                              onClick={() => {
                                const url = (f as any).url || "";
                                if (url) {
                                  setEventEdits(prev => ({ ...prev, [ev.id]: { ...prev[ev.id], hero: url } }));
                                  setRegisterEventsAll(prev => prev.map(item => item.id === ev.id ? { ...item, officialFlyerUrl: url } : item));
                                }
                              }}
                              className="border rounded-lg overflow-hidden bg-gray-50 hover:ring-2 hover:ring-indigo-300"
                            >
                              {/* eslint-disable-next-line @next/next/no-img-element */}
                              <img src={(f as any).url || ""} alt={(f as any).name || "file"} className="w-full h-16 object-cover" />
                              <div className="px-1 py-1 text-[10px] text-gray-600 truncate">{(f as any).name || "קובץ"}</div>
                            </button>
                          ))}
                        </div>
                      )}
                      <div className="flex justify-end">
                        <button
                          type="button"
                          className="px-3 py-1 rounded-lg text-xs font-semibold border border-indigo-200 text-indigo-700 hover:bg-indigo-50"
                          onClick={async (e) => {
                            e.preventDefault();
                            if (!db || !isAdmin) return;
                            const draft = eventEdits[ev.id] || {};
                            const updates: any = {};
                            if (draft.title !== undefined) updates.title = draft.title;
                            if (draft.description !== undefined) updates.description = draft.description;
                            if (draft.location !== undefined) updates.location = draft.location;
                            if (draft.startTime !== undefined) {
                              const d = draft.startTime ? new Date(draft.startTime) : null;
                              if (d && !isNaN(d.getTime())) updates.startTime = d;
                            }
                            if (draft.hero !== undefined) updates.officialFlyerUrl = draft.hero;
                            try {
                              await updateDoc(doc(db, "events", ev.id), updates);
                              setRegisterEventsAll(prev => prev.map(item => item.id === ev.id ? { ...item, ...updates } : item));
                              alert("עודכן");
                            } catch (err) {
                              console.error("Error updating event", err);
                              alert("שגיאה בעדכון האירוע");
                            }
                          }}
                        >
                          שמור אירוע
                        </button>
                      </div>
                    </div>
                  </label>
                );
              })}
            </div>
            <div className="flex justify-end gap-2">
              <button
                onClick={() => setShowRegisterEventsModal(false)}
                className="px-3 py-2 rounded-lg text-sm font-semibold text-gray-700 border border-gray-200 hover:bg-gray-50"
              >
                ביטול
              </button>
              <button
                onClick={async () => {
                  if (!db || !isAdmin) return;
                  setSavingRegisterEvents(true);
                  try {
                    await setDoc(doc(db, "settings", "public_register_events"), {
                      allowedEventIds: Array.from(registerEventsSelection),
                      updatedAt: serverTimestamp(),
                    });
                    setShowRegisterEventsModal(false);
                  } catch (err) {
                    console.error("Error saving register events", err);
                    alert("לא הצלחנו לשמור את בחירת האירועים");
                  } finally {
                    setSavingRegisterEvents(false);
                  }
                }}
                disabled={savingRegisterEvents}
                className="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-60"
              >
                {savingRegisterEvents ? "שומר..." : "שמור"}
              </button>
            </div>
          </div>
        </div>
      )}

      {activePanel === "stats" && (
        <div className="mt-4 bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
          <div className="flex items-center gap-2 mb-4">
            <BarChart3 style={{ color: 'var(--patifon-orange)' }} />
            <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>סטטיסטיקות על האירועים שלי</h2>
          </div>
          {loadingStats ? (
            <div className="text-gray-500 text-center py-6">טוען נתונים...</div>
          ) : (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="p-4 border border-gray-200 rounded-lg flex items-center gap-3">
                <div className="p-2 rounded-full" style={{ background: 'var(--patifon-cream-dark)' }}>
                  <Calendar size={20} className="text-gray-700" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">אירועים שפתחתי</p>
                  <p className="text-2xl font-bold text-gray-900">{stats.myEvents}</p>
                </div>
              </div>
              <div className="p-4 border border-gray-200 rounded-lg flex items-center gap-3">
                <div className="p-2 rounded-full" style={{ background: 'var(--patifon-cream-dark)' }}>
                  <Users size={20} className="text-gray-700" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">נרשמים דרך הטפסים</p>
                  <p className="text-2xl font-bold text-gray-900">{stats.attendees}</p>
                </div>
              </div>
              <div className="p-4 border border-gray-200 rounded-lg flex items-center gap-3">
                <div className="p-2 rounded-full" style={{ background: 'var(--patifon-cream-dark)' }}>
                  <UserPlus size={20} className="text-gray-700" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">שותפים שהצטרפו</p>
                  <p className="text-2xl font-bold text-gray-900">{stats.partners}</p>
                </div>
              </div>
              <div className="p-4 border border-gray-200 rounded-lg flex items-center gap-3">
                <div className="p-2 rounded-full" style={{ background: 'var(--patifon-cream-dark)' }}>
                  <CheckSquare size={20} className="text-gray-700" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">משימות שבוצעו</p>
                  <p className="text-2xl font-bold text-gray-900">{stats.tasks}</p>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {activePanel === "users" && (
        <div className="mt-4 bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
          <div className="flex items-center gap-2 mb-4">
            <Users style={{ color: 'var(--patifon-orange)' }} />
            <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>משתמשי המערכת</h2>
          </div>
          {usersError && (
            <div className="text-red-600 text-sm mb-3">{usersError}</div>
          )}
          {loadingUsers ? (
            <div className="text-gray-500 text-center py-6">טוען משתמשים...</div>
          ) : usersList.length === 0 ? (
            <div className="text-gray-500 text-center py-6">לא נמצאו משתמשים.</div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {usersList.map((u) => {
                const userActiveEvents =
                  userEventsMap[u.id] ||
                  (u.email ? userEventsMap[normalizeKey(u.email)] : []) ||
                  [];
                const isOpen = openUserEventsId === u.id;
                return (
                  <div key={u.id} className="p-3 border border-gray-200 rounded-lg bg-white">
                    <div className="flex items-center gap-3 justify-between">
                      <div className="flex items-center gap-3 min-w-0">
                        <div className="p-2 rounded-full" style={{ background: 'var(--patifon-cream-dark)' }}>
                          <UserCircle2 size={22} className="text-gray-700" />
                        </div>
                        <div className="min-w-0">
                          <p className="font-semibold text-gray-900 truncate">{u.fullName || u.email || "משתמש ללא שם"}</p>
                          <p className="text-sm text-gray-500 truncate">{u.role || "ללא תפקיד"}</p>
                        </div>
                      </div>
                      <button
                        className="flex items-center gap-1 px-3 py-1 rounded-full border border-gray-200 text-xs font-semibold text-gray-700 hover:bg-gray-50"
                        onClick={() => setOpenUserEventsId(isOpen ? null : u.id)}
                        title="הצג אירועים פעילים של המשתמש"
                      >
                        <Calendar size={14} />
                        <span>{userActiveEvents.length}</span>
                      </button>
                    </div>
                    {isOpen && userActiveEvents.length > 0 && (
                      <div className="mt-3 space-y-2">
                        {userActiveEvents.map(ev => (
                          <div key={ev.id} className="p-2 border border-gray-100 rounded-lg flex items-start gap-2 bg-gray-50">
                            <div className="p-1.5 rounded-full bg-white border border-gray-200">
                              <Calendar size={14} className="text-gray-700" />
                            </div>
                            <div className="min-w-0">
                              <p className="text-sm font-semibold text-gray-900 truncate">{ev.title || "אירוע ללא שם"}</p>
                              <p className="text-xs text-gray-500 truncate">{formatEventDate(ev.startTime) || "ללא תאריך"}</p>
                              <div className="flex items-center gap-1 mt-1 text-xs text-gray-600">
                                <Users size={12} />
                                <span>נרשמים:</span>
                                <span>{(ev as any).attendeesCount ?? "—"}</span>
                              </div>
                              <div className="mt-2">
                                <button
                                  onClick={() => handleJoinEventRequest(ev)}
                                  disabled={joinRequests[ev.id] === "PENDING" || joinRequests[ev.id] === "APPROVED"}
                                  className={`text-xs px-3 py-1 rounded-full border transition ${joinRequests[ev.id] === "PENDING" || joinRequests[ev.id] === "APPROVED"
                                    ? "border-gray-200 text-gray-500 bg-gray-100 cursor-not-allowed"
                                    : "border-indigo-200 text-indigo-700 hover:bg-indigo-50"
                                    }`}
                                >
                                  {joinRequests[ev.id] === "PENDING"
                                    ? "ממתין לאישור"
                                    : joinRequests[ev.id] === "APPROVED"
                                      ? "מאושר"
                                      : "הצטרף לצוות"}
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                    {isOpen && userActiveEvents.length === 0 && (
                      <div className="mt-3 text-xs text-gray-500">אין אירועים פעילים למשתמש זה.</div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {activePanel === "volunteers" && (
        <div className="mt-4 bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <UserPlus style={{ color: 'var(--patifon-orange)' }} />
              <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>מתנדבים רשומים</h2>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={exportVolunteersToCsv}
                disabled={!volunteersList.length}
                className={`px-3 py-1.5 rounded-lg text-xs font-semibold border transition ${volunteersList.length
                  ? "bg-white border-indigo-200 text-indigo-800 hover:bg-indigo-50"
                  : "bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed"
                  }`}
                title="ייצא את כל המתנדבים לטבלת אקסל"
              >
                ייצוא לאקסל
              </button>
              <span className="px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-800 border border-indigo-100">
                {filteredVolunteers.length}
              </span>
            </div>
          </div>
          <div className="flex flex-wrap gap-3 mb-4">
            <div className="flex-1 min-w-[220px]">
              <input
                type="search"
                value={volunteerSearch}
                onChange={(e) => setVolunteerSearch(e.target.value)}
                placeholder="חיפוש לפי שם מתנדב"
                className="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>
            <button
              onClick={() => {
                const url = typeof window !== "undefined" ? `${window.location.origin}/volunteers/register` : "/volunteers/register";
                if (navigator?.clipboard?.writeText) {
                  navigator.clipboard.writeText(url).then(() => {
                    alert("קישור הרשמה כללי הועתק");
                  }).catch(() => {
                    alert(url);
                  });
                } else {
                  alert(url);
                }
              }}
              className="px-3 py-2 rounded-lg border border-indigo-200 text-indigo-800 bg-indigo-50 hover:bg-indigo-100 text-xs font-semibold"
            >
              העתק קישור הרשמת מתנדב כללי
            </button>
          </div>
          {completionRequests.length > 0 && (
            <div className="mb-4 bg-amber-50 border border-amber-200 rounded-lg p-4">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <Bell className="text-amber-700" size={18} />
                  <h3 className="font-semibold text-amber-900">בקשות לאישור משימות</h3>
                </div>
                <span className="text-xs px-2 py-0.5 rounded-full bg-white border border-amber-200 text-amber-800">{completionRequests.length}</span>
              </div>
              <div className="space-y-3 max-h-64 overflow-y-auto pr-1">
                {completionRequests.map((req) => {
                  const requestTypeLabel = req.manualRequest
                    ? "דיווח ידני"
                    : req.scope === "project"
                      ? "פרויקט"
                      : "אירוע";
                  return (
                    <div key={req.id} className="border border-amber-200 rounded-lg p-3 bg-white">
                      <div className="flex items-center justify-between">
                        <div className="min-w-0">
                          <p className="font-semibold text-gray-900 truncate">{req.taskTitle || "משימה"}</p>
                          <p className="text-sm text-gray-600 truncate">אירוע/פרויקט: {req.eventTitle || req.eventId || "נקבע"}</p>
                          <p className="text-sm text-gray-600 truncate">מתנדב: {req.volunteerName || req.volunteerEmail}</p>
                          {req.notes && (
                            <p className="text-xs text-gray-500 mt-1 line-clamp-2">הערות: {req.notes}</p>
                          )}
                        </div>
                        <span className="text-xs px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-100">{requestTypeLabel}</span>
                      </div>
                      <div className="flex gap-2 mt-3">
                        <button
                          onClick={() => handleApproveCompletion(req, true)}
                          className="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700"
                        >
                          אשר ביצוע
                        </button>
                        <button
                          onClick={() => handleApproveCompletion(req, false)}
                          className="px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm font-semibold hover:bg-red-700"
                        >
                          דחה
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          {volunteerErrorLog.length > 0 && (
            <div className="mb-4 bg-red-50 border border-red-200 rounded-lg p-4">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <AlertTriangle className="text-red-700" size={18} />
                  <h3 className="font-semibold text-red-900">שגיאות בדיווחי משימות מתנדבים</h3>
                </div>
                <span className="text-xs px-2 py-0.5 rounded-full bg-white border border-red-200 text-red-800">{volunteerErrorLog.length}</span>
              </div>
              <div className="space-y-3 max-h-72 overflow-y-auto pr-1">
                {volunteerErrorLog.map((entry) => {
                  const actionLabel = entry.action.type === "approve_completion"
                    ? entry.action.approve ? "אישור ביצוע" : "דחיית ביצוע"
                    : "הוספת דיווח ידני";
                  const scopeLabel = entry.context?.scope === "project"
                    ? "פרויקט"
                    : entry.context?.scope === "manual"
                      ? "דיווח ידני"
                      : "אירוע";
                  return (
                    <div key={entry.id} className="border border-red-200 rounded-lg p-3 bg-white">
                      <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                          <p className="font-semibold text-gray-900 truncate">{entry.title}</p>
                          <p className="text-sm text-red-700 break-words">{entry.reason}</p>
                          <p className="text-xs text-gray-600 mt-1 space-x-1 rtl:space-x-reverse">
                            <span>פעולה: {actionLabel}</span>
                            <span>•</span>
                            <span>סוג: {scopeLabel}</span>
                            {entry.context?.taskTitle && (
                              <>
                                <span>•</span>
                                <span>משימה: {entry.context.taskTitle}</span>
                              </>
                            )}
                            {entry.context?.eventTitle && (
                              <>
                                <span>•</span>
                                <span>אירוע/פרויקט: {entry.context.eventTitle}</span>
                              </>
                            )}
                            {entry.context?.volunteerEmail && (
                              <>
                                <span>•</span>
                                <span>מתנדב: {entry.context.volunteerEmail}</span>
                              </>
                            )}
                          </p>
                          <p className="text-[11px] text-gray-400 mt-1">{formatVolunteerErrorTime(entry.ts)}</p>
                        </div>
                        <div className="flex flex-col gap-2 shrink-0">
                          <button
                            onClick={() => retryVolunteerError(entry.id)}
                            disabled={!!retryingErrorIds[entry.id]}
                            className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${retryingErrorIds[entry.id]
                              ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                              : "bg-red-600 text-white hover:bg-red-700"
                              }`}
                          >
                            {retryingErrorIds[entry.id] ? "מנסה..." : "נסה שוב"}
                          </button>
                          <button
                            onClick={() => dismissVolunteerError(entry.id)}
                            className="px-3 py-1.5 rounded-lg text-sm font-semibold border border-red-200 text-red-700 bg-white hover:bg-red-50"
                          >
                            סמן כטופל
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          {loadingVolunteers ? (
            <div className="text-gray-500 text-center py-6">טוען מתנדבים...</div>
          ) : filteredVolunteers.length === 0 ? (
            <div className="text-gray-500 text-center py-6">לא נמצאו מתנדבים מתאימים לחיפוש.</div>
          ) : (
            <>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {(showAllVolunteers ? filteredVolunteers : filteredVolunteers.slice(0, 5)).map((vol) => {
                  const regDate = vol.createdAt?.seconds ? new Date(vol.createdAt.seconds * 1000) : null;
                  const deletingKey = `${vol.scope || "event"}-${vol.eventId}-${vol.id}`;
                  const canSendWhatsapp = !!normalizePhoneValue(vol.phone || vol.phoneNormalized || "");
                  return (
                    <div
                      key={`${vol.scope || "event"}-${vol.eventId}-${vol.id}`}
                      className="p-3 border border-gray-200 rounded-lg bg-white cursor-pointer hover:border-indigo-200"
                      onClick={() => { setViewVolunteer(vol); loadVolunteerTasks(vol); }}
                    >
                      <div className="flex items-start gap-3 justify-between">
                        <div className="flex items-start gap-3 min-w-0 flex-1">
                          <div className="p-2 rounded-full" style={{ background: 'var(--patifon-cream-dark)' }}>
                            <UserPlus size={18} className="text-gray-700" />
                          </div>
                          <div className="min-w-0 flex-1">
                            <div className="flex items-center gap-2">
                              <p className="font-semibold text-gray-900 truncate">{vol.name || "מתנדב ללא שם"}</p>
                              <span className="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 border border-gray-200">
                                {vol.scope === "project" ? "פרויקט" : "אירוע"}
                              </span>
                            </div>
                            {vol.email && (
                              <p className="text-sm text-gray-500 truncate">{vol.email}</p>
                            )}
                            {vol.phone && (
                              <p className="text-sm text-gray-500 truncate">{vol.phone}</p>
                            )}
                            <div className="mt-2 space-y-1">
                              {vol.eventTitle && vol.eventId && (
                                <Link
                                  href={vol.scope === "project" ? `/projects/${vol.eventId}` : `/events/${vol.eventId}`}
                                  className="text-xs text-indigo-600 hover:text-indigo-800 hover:underline truncate flex items-center gap-1"
                                >
                                  {vol.scope === "project" ? <FolderKanban size={12} /> : <Calendar size={12} />}
                                  {vol.eventTitle}
                                </Link>
                              )}
                              {regDate && (
                                <p className="text-xs text-gray-500">
                                  {regDate.toLocaleDateString("he-IL", { day: "2-digit", month: "2-digit", year: "numeric" })} • {regDate.toLocaleTimeString("he-IL", { hour: "2-digit", minute: "2-digit" })}
                                </p>
                              )}
                            </div>
                          </div>
                        </div>
                        {isAdmin && (
                          <div className="flex flex-col gap-2">
                            <button
                              onClick={() => startEditVolunteer(vol)}
                              className="p-2 rounded-md border border-gray-200 hover:bg-gray-50 text-gray-700"
                              title="עריכת מתנדב"
                            >
                              <Edit2 size={16} />
                            </button>
                            <button
                              onClick={() => setConfirmDeleteVolunteer(vol)}
                              disabled={deletingVolunteerId === deletingKey}
                              className={`p-2 rounded-md border text-gray-700 ${deletingVolunteerId === deletingKey ? "bg-gray-100 border-gray-200 cursor-not-allowed" : "border-gray-200 hover:bg-gray-50"}`}
                              title="מחיקת מתנדב"
                            >
                              <Trash2 size={16} />
                            </button>
                            <button
                              onClick={(e) => { e.stopPropagation(); handleSendVolunteerWhatsapp(vol); }}
                              disabled={!canSendWhatsapp}
                              className={`p-2 rounded-md border text-gray-700 ${canSendWhatsapp ? "border-gray-200 hover:bg-gray-50" : "bg-gray-100 border-gray-200 cursor-not-allowed"}`}
                              title={canSendWhatsapp ? "שליחת הודעת וואטסאפ" : "אין מספר וואטסאפ"}
                            >
                              <MessageCircle size={16} />
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
              {filteredVolunteers.length > 5 && (
                <div className="mt-4 flex justify-center">
                  <button
                    onClick={() => setShowAllVolunteers(!showAllVolunteers)}
                    className="px-4 py-2 rounded-lg border border-indigo-200 text-indigo-700 hover:bg-indigo-50 transition text-sm font-medium"
                  >
                    {showAllVolunteers ? "הצג 5 ראשונים בלבד" : `הצג את כל ${filteredVolunteers.length} המתנדבים`}
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      )}

      {isAdmin && activePanel === "registrants" && (
        <div className="mt-4 bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <Users style={{ color: 'var(--patifon-orange)' }} />
              <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>נרשמים לאירועים</h2>
            </div>
            <div className="flex items-center gap-2">
              {isAdmin && (
                <button
                  type="button"
                  onClick={() => setShowRegisterEventsModal(true)}
                  className="px-3 py-1.5 rounded-lg text-xs font-semibold border border-gray-200 text-gray-700 hover:bg-gray-50"
                >
                  עריכת אירועים
                </button>
              )}
              <button
                type="button"
                onClick={() => {
                  const url = typeof window !== "undefined" ? `${window.location.origin}/events/register` : "/events/register";
                  if (navigator?.clipboard?.writeText) {
                    navigator.clipboard.writeText(url).then(() => alert("קישור דף הנרשמים הועתק")).catch(() => alert(url));
                  } else {
                    alert(url);
                  }
                }}
                className="px-3 py-1.5 rounded-lg text-xs font-semibold border border-indigo-200 text-indigo-800 bg-indigo-50 hover:bg-indigo-100"
              >
                העתק קישור לדף הרשמה
              </button>
              <span className="px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-800 border border-indigo-100">
                {filteredRegistrants.length}
              </span>
            </div>
          </div>
          <div className="flex flex-wrap gap-3 mb-4">
            <div className="flex-1 min-w-[220px]">
              <input
                type="search"
                value={registrantSearch}
                onChange={(e) => setRegistrantSearch(e.target.value)}
                placeholder="חיפוש לפי שם/מייל/טלפון/אירוע"
                className="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>
          </div>
          {loadingRegistrants ? (
            <div className="text-gray-500 text-center py-6">טוען נרשמים...</div>
          ) : filteredRegistrants.length === 0 ? (
            <div className="text-gray-500 text-center py-6">לא נמצאו נרשמים.</div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {filteredRegistrants.map((reg) => {
                const regDate = reg.createdAt?.seconds ? new Date(reg.createdAt.seconds * 1000) : null;
                return (
                  <div key={reg.id} className="border border-gray-200 rounded-lg p-3 bg-white shadow-sm">
                    <div className="flex items-center justify-between gap-3">
                      <div>
                        <p className="font-semibold text-gray-900">{reg.name || "נרשם ללא שם"}</p>
                        <p className="text-xs text-gray-500 truncate">{reg.email || "ללא מייל"}</p>
                        {reg.phone && <p className="text-xs text-gray-500">{reg.phone}</p>}
                        <p className="text-xs text-gray-600 mt-1">אירוע: {reg.eventTitle || reg.eventId || "לא ידוע"}</p>
                        {regDate && (
                          <p className="text-[11px] text-gray-400">נרשם ב־{regDate.toLocaleString("he-IL", { dateStyle: "short", timeStyle: "short" })}</p>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {editingVolunteer && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">עריכת מתנדב</h3>
            <form className="space-y-4" onSubmit={handleSaveVolunteer}>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">שם</label>
                <input
                  type="text"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  value={editVolunteerName}
                  onChange={(e) => setEditVolunteerName(e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">אימייל</label>
                <input
                  type="email"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  value={editVolunteerEmail}
                  onChange={(e) => setEditVolunteerEmail(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">טלפון</label>
                <input
                  type="tel"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  value={editVolunteerPhone}
                  onChange={(e) => setEditVolunteerPhone(e.target.value)}
                />
              </div>
              <div className="flex items-center justify-end gap-3 pt-2">
                <button
                  type="button"
                  className="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50"
                  onClick={closeVolunteerEditor}
                  disabled={savingVolunteer}
                >
                  ביטול
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-70"
                  disabled={savingVolunteer}
                >
                  {savingVolunteer ? "שומר..." : "שמור"}
                </button>
              </div>
            </form>
            <div className="mt-6 space-y-3 rounded-xl border border-dashed border-gray-200 bg-gray-50 p-4">
              <div className="flex items-center justify-between">
                <p className="text-sm font-semibold text-gray-800">הוספת משימה ידנית</p>
                <p className="text-xs text-gray-500">הרשאה למנהלים בלבד</p>
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">שם המשימה</label>
                <input
                  type="text"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  value={manualTaskTitle}
                  onChange={(e) => setManualTaskTitle(e.target.value)}
                  placeholder="לדוגמה: אריזת מתנות"
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">אירוע / פרויקט (אופציונלי)</label>
                <input
                  type="text"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  value={manualEventTitle}
                  onChange={(e) => setManualEventTitle(e.target.value)}
                  placeholder="שם האירוע או הפרויקט שבו בוצעה המשימה"
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">שעות בפועל</label>
                <input
                  type="number"
                  min="0"
                  step="0.25"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  value={manualTaskHours}
                  onChange={(e) => setManualTaskHours(e.target.value)}
                  placeholder="לדוגמה: 3.5"
                />
              </div>
              <button
                type="button"
                disabled={manualSaving}
                onClick={handleAddManualCompletion}
                className="w-full rounded-lg bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-70"
              >
                {manualSaving ? "שומר..." : "הוסף משימה ידנית"}
              </button>
            </div>
          </div>
        </div>
      )}

      {assigneeWhatsappModal && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div className="flex items-start justify-between mb-4">
              <div>
                <h3 className="text-xl font-bold text-gray-900">שליחת הודעת מערכת בוואטסאפ</h3>
                <p className="text-sm text-gray-600">
                  אל: {assigneeWhatsappModal.assigneeName || assigneeWhatsappModal.assigneeEmail || "משתמש"} • {assigneeWhatsappModal.taskTitle}
                </p>
              </div>
              <button onClick={closeAssigneeWhatsappModal} className="text-gray-500 hover:text-gray-700">
                <X size={18} />
              </button>
            </div>

            <div className="space-y-3">
              <div>
                <label className="text-sm font-medium text-gray-800 mb-1 block">טלפון יעד</label>
                <input
                  type="tel"
                  value={assigneeWhatsappModal.phone}
                  onChange={(e) => setAssigneeWhatsappModal(prev => prev ? { ...prev, phone: e.target.value } : prev)}
                  className="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                  placeholder="לדוגמה: 0501234567"
                />
                {assigneeWhatsappModal.loadingPhone && (
                  <p className="text-xs text-gray-500 mt-1">מאחזר מספר טלפון מהפרופיל...</p>
                )}
              </div>
              <div>
                <label className="text-sm font-medium text-gray-800 mb-1 block">תוכן הודעה</label>
                <textarea
                  value={assigneeWhatsappModal.message}
                  onChange={(e) => setAssigneeWhatsappModal(prev => prev ? { ...prev, message: e.target.value } : prev)}
                  rows={4}
                  className="w-full border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                />
              </div>
              {assigneeWhatsappModal.error && (
                <div className="text-sm text-red-600">{assigneeWhatsappModal.error}</div>
              )}
              <div className="flex justify-end gap-2">
                <button
                  onClick={closeAssigneeWhatsappModal}
                  className="px-3 py-2 rounded-lg border border-gray-200 text-sm font-semibold text-gray-700 hover:bg-gray-50"
                >
                  ביטול
                </button>
                <button
                  onClick={handleSendAssigneeWhatsapp}
                  disabled={assigneeWhatsappModal.sending}
                  className="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 disabled:opacity-60"
                >
                  {assigneeWhatsappModal.sending ? "שולח..." : "שלח בוואטסאפ"}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {viewVolunteer && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg w-full max-w-3xl p-6 max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between items-start mb-4">
              <div>
                <h3 className="text-xl font-bold text-gray-900">
                  {viewVolunteer.name || `${viewVolunteer.firstName || ""} ${viewVolunteer.lastName || ""}`.trim() || "מתנדב"}
                </h3>
                <p className="text-sm text-gray-600">{viewVolunteer.email || ""}</p>
                {viewVolunteer.phone && <p className="text-sm text-gray-600">טלפון: {viewVolunteer.phone}</p>}
                {viewVolunteer.firstName && <p className="text-sm text-gray-600">שם פרטי: {viewVolunteer.firstName}</p>}
                {viewVolunteer.lastName && <p className="text-sm text-gray-600">שם משפחה: {viewVolunteer.lastName}</p>}
                {viewVolunteer.program && <p className="text-sm text-gray-600">חוג/תחום לימוד: {viewVolunteer.program}</p>}
                {viewVolunteer.year && <p className="text-sm text-gray-600">שנת לימודים: {viewVolunteer.year}</p>}
                {viewVolunteer.idNumber && <p className="text-sm text-gray-600">ת.ז: {viewVolunteer.idNumber}</p>}
              </div>
              <button
                onClick={() => { setViewVolunteer(null); setVolTasksPending([]); setVolTasksDone([]); setVolTasksHours(0); }}
                className="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100"
              >
                <X size={18} />
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              {volTasksError && (
                <div className="md:col-span-2 bg-red-50 border border-red-200 text-red-700 rounded-lg p-3 text-sm">
                  {volTasksError}
                </div>
              )}
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="font-semibold text-gray-900">משימות פתוחות</h4>
                  <span className="px-2 py-0.5 rounded-full text-xs font-semibold bg-white border border-amber-200">{volTasksPending.length}</span>
                </div>
                {loadingVolTasks ? (
                  <p className="text-sm text-gray-500">טוען...</p>
                ) : volTasksPending.length === 0 ? (
                  <p className="text-sm text-gray-500">אין משימות פתוחות.</p>
                ) : (
                  <div className="space-y-2">
                    {volTasksPending.map((t) => (
                      <div key={t.id} className="p-2 rounded border border-gray-200 bg-white">
                        <div className="flex items-center justify-between text-sm mb-1">
                          <span className="font-semibold text-gray-900 truncate">{t.title}</span>
                          <span className="text-xs text-gray-500">{t.eventTitle}</span>
                        </div>
                        {t.volunteerHours != null && <p className="text-xs text-gray-700">שעות משימה: {t.volunteerHours}</p>}
                        {t.dueDate && <p className="text-xs text-gray-600">דד ליין: {t.dueDate}</p>}
                        <p className="text-xs text-gray-600">סוג: {t.scope === "project" ? "פרויקט" : "אירוע"}</p>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="font-semibold text-gray-900">משימות שהושלמו</h4>
                  <span className="px-2 py-0.5 rounded-full text-xs font-semibold bg-white border border-green-200">{volTasksDone.length}</span>
                </div>
                {loadingVolTasks ? (
                  <p className="text-sm text-gray-500">טוען...</p>
                ) : volTasksDone.length === 0 ? (
                  <p className="text-sm text-gray-500">אין משימות שהושלמו.</p>
                ) : (
                  <div className="space-y-2">
                    {volTasksDone.map((t) => (
                      <div key={t.id} className="p-2 rounded border border-gray-200 bg-white">
                        <div className="flex items-center justify-between text-sm mb-1">
                          <span className="font-semibold text-gray-900 truncate">{t.title}</span>
                          <span className="text-xs text-gray-500">{t.eventTitle}</span>
                        </div>
                        {t.volunteerHours != null && <p className="text-xs text-gray-700">שעות משימה: {t.volunteerHours}</p>}
                        <p className="text-xs text-gray-600">סוג: {t.scope === "project" ? "פרויקט" : "אירוע"}</p>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
              <p className="text-sm font-semibold text-indigo-800">
                סה״כ שעות שצבר: {volTasksHours}
              </p>
            </div>
          </div>
        </div>
      )}

      {confirmDeleteVolunteer && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-3">מחיקת מתנדב</h3>
            <p className="text-sm text-gray-700 mb-4">
              למחוק את המתנדב/ת "{confirmDeleteVolunteer.name || confirmDeleteVolunteer.id}"?
            </p>
            <div className="text-xs text-gray-500 mb-4">
              מקור: {confirmDeleteVolunteer.scope === "project" ? "פרויקט" : "אירוע"} • {confirmDeleteVolunteer.eventTitle || confirmDeleteVolunteer.eventId}
            </div>
            <div className="flex items-center justify-end gap-3">
              <button
                type="button"
                className="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50"
                onClick={() => setConfirmDeleteVolunteer(null)}
                disabled={deletingVolunteerId !== null}
              >
                ביטול
              </button>
              <button
                type="button"
                className="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 disabled:opacity-70"
                onClick={() => handleDeleteVolunteer()}
                disabled={deletingVolunteerId !== null}
              >
                {deletingVolunteerId ? "מוחק..." : "מחק"}
              </button>
            </div>
          </div>
        </div>
      )}

      {activePanel === "notifications" && (
        <div className="mt-4 bg-white p-6 rounded-xl vinyl-shadow" style={{ border: '2px solid var(--patifon-cream-dark)' }}>
          <div className="flex items-center gap-2 mb-4">
            <Bell style={{ color: 'var(--patifon-orange)' }} />
            <h2 className="text-xl font-semibold" style={{ color: 'var(--patifon-burgundy)' }}>הודעות והתראות</h2>
          </div>
          {loadingNotifications ? (
            <div className="text-gray-500 text-center py-6">טוען התראות...</div>
          ) : (
            <div className="space-y-3">
              <div className="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <p className="text-sm font-semibold text-gray-800 mb-2">בקשות הצטרפות לאירועים שלי</p>
                {incomingJoinRequests.length === 0 ? (
                  <p className="text-xs text-gray-500">אין בקשות חדשות.</p>
                ) : (
                  incomingJoinRequests.map((req) => (
                    <div key={req.id} className="flex items-start justify-between gap-3 bg-white border border-gray-200 rounded-lg p-3 mb-2">
                      <div className="min-w-0">
                        <p className="text-sm font-semibold text-gray-900 truncate">{req.requesterName || req.requesterEmail || "משתמש"}</p>
                        <p className="text-xs text-gray-500 truncate">אירוע: {req.eventTitle || req.eventId}</p>
                        <p className="text-xs text-gray-500 truncate">סטטוס: {req.status === "PENDING" ? "ממתין" : req.status === "APPROVED" ? "אושר" : "נדחה"}</p>
                      </div>
                      <div className="flex items-center gap-2 shrink-0">
                        <button
                          onClick={() => handleApproveJoinRequest(req.id)}
                          className="px-3 py-1 text-xs rounded-full bg-green-600 text-white hover:bg-green-700"
                        >
                          אשר
                        </button>
                        <button
                          onClick={() => handleRejectJoinRequest(req.id)}
                          className="px-3 py-1 text-xs rounded-full border border-gray-200 text-gray-700 hover:bg-gray-50"
                        >
                          דחה
                        </button>
                      </div>
                    </div>
                  ))
                )}
              </div>
              <div className="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <p className="text-sm font-semibold text-gray-800 mb-2">הודעות ממשימות שמוקצות לי</p>
                {taskNotifications.length === 0 ? (
                  <p className="text-xs text-gray-500">אין הודעות חדשות.</p>
                ) : (
                  taskNotifications.map(t => (
                    <div key={t.id} className="flex items-start justify-between gap-3 bg-white border border-gray-200 rounded-lg p-3 mb-2">
                      <div className="min-w-0">
                        <div className="flex items-center gap-2">
                          <p className="text-sm font-semibold text-gray-900 truncate">{t.title}</p>
                          {(!t.readBy || !t.readBy[currentUid]) && (
                            <span className="inline-block w-2 h-2 rounded-full bg-red-500" title="לא נקרא"></span>
                          )}
                        </div>
                        <p className="text-xs text-gray-500 truncate">אירוע: {t.eventTitle}</p>
                        <p className="text-xs text-gray-700 truncate">{t.lastMessageText || "הודעה חדשה"}</p>
                      </div>
                      <div className="flex items-center gap-2">
                        <button
                          onClick={() => setChatTask(t)}
                          className="px-3 py-1 text-xs rounded-full border border-indigo-200 text-indigo-700 hover:bg-indigo-50"
                        >
                          פתח צ'אט
                        </button>
                        <button
                          onClick={() => setNotificationTasks(prev => prev.filter(nt => nt.id !== t.id))}
                          className="px-3 py-1 text-xs rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50"
                          title="הסר מההתראות"
                        >
                          הסר
                        </button>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          )}
        </div>
      )}

      {/* Date Edit Modal */}
      {editingDateTask && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-lg max-w-sm w-full p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold">שינוי תאריך יעד</h3>
              <button onClick={() => setEditingDateTask(null)} className="text-gray-400 hover:text-gray-600"><X size={20} /></button>
            </div>
            <form onSubmit={async (e) => {
              e.preventDefault();
              if (!db || !editingDateTask) return;
              try {
                const taskRef = editingDateTask.scope === "project"
                  ? doc(db, "projects", editingDateTask.eventId, "tasks", editingDateTask.id)
                  : doc(db, "events", editingDateTask.eventId, "tasks", editingDateTask.id);
                await updateDoc(taskRef, {
                  dueDate: editingDateTask.dueDate,
                });
                setMyTasks(prev => prev.map(t => t.id === editingDateTask.id ? editingDateTask : t));
                setEditingDateTask(null);
              } catch (err) {
                console.error("Error updating date:", err);
                alert("שגיאה בעדכון התאריך");
              }
            }} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">תאריך יעד</label>
                <input
                  type="date"
                  className="w-full p-2 border rounded-lg text-sm"
                  value={editingDateTask.dueDate}
                  onChange={e => setEditingDateTask({ ...editingDateTask, dueDate: e.target.value })}
                  autoFocus
                />
              </div>
              <div className="flex justify-end gap-3 pt-4">
                <button type="button" onClick={() => setEditingDateTask(null)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium">ביטול</button>
                <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700">שמור</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
